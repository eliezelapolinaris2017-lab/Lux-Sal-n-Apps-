<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Confirmacitas ‚Äì Sal√≥n</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f2230">
<style>
  :root{
    /* ====== PALETA EDITABLE DESDE CONFIGURACI√ìN (se sincroniza al cargar) ====== */
    --bg:#0e1a24;
    --panel:#0f2230;
    --panel-2:#0c1c28;
    --ink:#e8f0f6;
    --muted:#a6bdcc;
    --accent:#4cc2ff;
    --ok:#32d296;
    --warn:#ffcf44;
    --danger:#ff5678;
    --line:#163042;
    --btn:#1e88e5;
    --btn-text:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,Noto Sans,sans-serif;
    color:var(--ink);
    background:radial-gradient(1200px circle at 10% 0%, #0f2230 10%, var(--bg) 55%);
  }
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  /* ===== Topbar: SOLO logos, nombre y bot√≥n Dashboard ===== */
  .topbar{
    position:sticky;top:0;z-index:10;
    display:flex;align-items:center;gap:12px;
    background:var(--panel);border-bottom:1px solid var(--line);
    padding:10px 14px;
  }
  .topbar .brand{
    display:flex;align-items:center;gap:10px;min-height:40px;
  }
  .brand img{height:36px;width:auto;object-fit:contain}
  .brand .name{font-weight:700;letter-spacing:.2px}
  .topbar .spacer{flex:1}
  .btn{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--btn);color:var(--btn-text);border:none;border-radius:10px;
    padding:10px 14px;font-weight:600;cursor:pointer;
    box-shadow:0 6px 16px rgba(0,0,0,.25);
  }
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line);box-shadow:none}
  .btn.small{padding:6px 10px;border-radius:8px;font-weight:600}
  .pill{display:inline-flex;align-items:center;gap:6px;background:var(--panel-2);border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px}
  /* ===== Tarjetas ===== */
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
  .section-title{font-weight:800;margin:6px 0 8px 0}
  .muted{color:var(--muted)}
  hr.sep{border:0;border-top:1px dashed var(--line);margin:12px 0}
  /* ===== Lista de funciones (men√∫ principal) ===== */
  .list{display:flex;flex-direction:column;gap:10px}
  .item{
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--line);border-radius:14px;padding:12px 12px;
  }
  .lead{display:flex;align-items:center;gap:12px}
  .icon{font-size:20px}
  .hint{color:var(--muted);font-size:12px;margin-top:4px}
  .stack{display:flex;flex-direction:column}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,select,textarea{
    background:var(--panel-2);border:1px solid var(--line);border-radius:10px;
    color:var(--ink);padding:10px;width:100%;
  }
  label{font-size:12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-12{grid-column:span 12}
  @media(max-width:800px){.col-6,.col-4,.col-3{grid-column:span 12}}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
  .badge{padding:4px 8px;border-radius:8px;background:var(--panel);border:1px solid var(--line);font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .danger{color:var(--danger)}
  .hidden{display:none !important}
  .center{text-align:center}
  .foot{margin:20px 0 80px;color:var(--muted);font-size:12px}
  .bg-preview{min-height:80px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--line);border-radius:12px;background-size:cover;background-position:center}
  .link{cursor:pointer;text-decoration:underline}
  .sticky-foot{position:sticky;bottom:0;background:var(--panel);border-top:1px solid var(--line);padding:10px}
</style>
</head>
<body>
<!-- ======= TOPBAR ======= -->
<div class="topbar">
  <div class="brand">
    <img id="logoHeader" alt="logo" src="" />
    <div class="name" id="salonName">Sal√≥n de Belleza</div>
  </div>
  <div class="spacer"></div>
  <button class="btn small" id="btnDashboard">üè† Dashboard</button>
</div>

<div class="wrap">
  <!-- ======= WELCOME / LOGIN ======= -->
  <div id="welcomeView" class="card">
    <div class="grid">
      <div class="col-12 center">
        <div class="bg-preview" id="welcomeBg" style="background-image:none;">
          <img id="logoWelcome" alt="logo" src="" style="max-height:80px;max-width:90%;object-fit:contain"/>
        </div>
        <div class="section-title" style="margin-top:10px" id="welcomeTitle">Bienvenido(a)</div>
        <div class="muted" id="welcomeSubtitle">Inicia sesi√≥n para continuar</div>
      </div>
      <div class="col-6">
        <div class="stack">
          <label>Usuario</label>
          <input id="loginUser" placeholder="usuario" autocomplete="username">
        </div>
      </div>
      <div class="col-6">
        <div class="stack">
          <label>Contrase√±a</label>
          <input id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" autocomplete="current-password">
        </div>
      </div>
      <div class="col-12 row">
        <button class="btn" id="btnLogin">Entrar</button>
        <span class="muted">¬øPrimera vez? <span class="link" id="btnSeedAdmin">Crear admin</span></span>
      </div>
      <div class="col-12">
        <div class="hint">PWA: Inst√°lala desde el men√∫ del navegador (Agregar a pantalla de inicio). Funciona sin internet tras la primera carga.</div>
      </div>
    </div>
  </div>

  <!-- ======= DASHBOARD (lista de funciones) ======= -->
  <div id="dashboardView" class="card hidden">
    <div class="list" id="mainMenu">
      <div class="item">
        <div class="lead"><div class="icon">üóìÔ∏è</div>
          <div class="stack">
            <div><b>Agendar cita</b></div>
            <div class="hint">Crear cita, enlace a Google Calendar y WhatsApp</div>
          </div>
        </div>
        <button class="btn small" id="goAgenda">Abrir</button>
      </div>

      <div class="item">
        <div class="lead"><div class="icon">üìÖ</div>
          <div class="stack"><div><b>Fechas disponibles</b></div><div class="hint">Filtrar por t√©cnica y fecha</div></div>
        </div>
        <button class="btn small" id="goDisponibilidad">Ver</button>
      </div>

      <div class="item">
        <div class="lead"><div class="icon">‚õî</div>
          <div class="stack"><div><b>No show</b></div><div class="hint">Listado de ausencias y gesti√≥n</div></div>
        </div>
        <button class="btn small" id="goNoShow">Abrir</button>
      </div>

      <div class="item">
        <div class="lead"><div class="icon">üí≥</div>
          <div class="stack"><div><b>Cobros / Facturas</b></div><div class="hint">ATH M√≥vil, cash, tarjeta + recibo exportable</div></div>
        </div>
        <button class="btn small" id="goCobros">Abrir</button>
      </div>

      <div class="item">
        <div class="lead"><div class="icon">üìà</div>
          <div class="stack"><div><b>Rendimiento</b></div><div class="hint">Citas, no show y cobros por periodo</div></div>
        </div>
        <button class="btn small adminOnly" id="goRendimiento">Abrir</button>
      </div>

      <div class="item">
        <div class="lead"><div class="icon">‚öôÔ∏è</div>
          <div class="stack"><div><b>Configuraci√≥n</b></div><div class="hint">Topbar/footer, logos, colores, t√©cnicas, servicios</div></div>
        </div>
        <button class="btn small adminOnly" id="goConfig">Abrir</button>
      </div>

      <div class="item">
        <div class="lead"><div class="icon">üìÑ</div>
          <div class="stack"><div><b>Hoja de cuadre diario (Sheets)</b></div><div class="hint">Abre Google Sheets</div></div>
        </div>
        <a class="btn small adminOnly" id="openSheets" href="https://docs.google.com/spreadsheets/d/1-MxlLqk6BLkYiThYros0F3DLCef0jd5tV-pUilMk3iM/edit" target="_blank" rel="noopener">Abrir</a>
      </div>

      <div class="item">
        <div class="lead"><div class="icon">üì¶</div>
          <div class="stack"><div><b>Backups & Exportaciones</b></div><div class="hint">Exportar/Importar JSON y CSV</div></div>
        </div>
        <button class="btn small adminOnly" id="goBackups">Abrir</button>
      </div>
    </div>
  </div>

  <!-- ======= AGENDA ======= -->
  <div id="agendaView" class="card hidden">
    <div class="row">
      <button class="btn small ghost goBack">‚¨ÖÔ∏é Men√∫</button>
      <div class="pill">Sin duplicados: misma persona + fecha + hora + t√©cnica = bloqueado</div>
    </div>
    <hr class="sep">
    <div class="grid">
      <div class="col-4">
        <div class="stack"><label>Cliente (Nombre)</label><input id="a_nombre" placeholder="Nombre cliente"></div>
      </div>
      <div class="col-4">
        <div class="stack"><label>Tel√©fono</label><input id="a_tel" placeholder="7871234567"></div>
      </div>
      <div class="col-4">
        <div class="stack"><label>T√©cnica/Estilista</label>
          <select id="a_tecnica"></select>
        </div>
      </div>
      <div class="col-3">
        <div class="stack"><label>Servicio</label>
          <select id="a_servicio"></select>
        </div>
      </div>
      <div class="col-3">
        <div class="stack"><label>Fecha</label><input id="a_fecha" type="date"></div>
      </div>
      <div class="col-3">
        <div class="stack"><label>Hora</label><input id="a_hora" type="time"></div>
      </div>
      <div class="col-3">
        <div class="stack"><label>Notas</label><input id="a_notas" placeholder="Notas"></div>
      </div>
      <div class="col-12 row">
        <button class="btn" id="btnCrearCita">Crear cita</button>
        <button class="btn ghost" id="btnEditarCita" disabled>Guardar cambios</button>
        <div class="pill">Se generan enlaces a Google Calendar y WhatsApp</div>
      </div>
    </div>
    <hr class="sep">
    <div class="row">
      <div class="pill">üîé Filtrar</div>
      <input id="filtroCitas" placeholder="Buscar por nombre/tel√©fono/fecha">
    </div>
    <div class="card">
      <table class="table" id="tblCitas">
        <thead><tr><th>Cliente</th><th>Tel√©fono</th><th>Servicio</th><th>T√©cnica</th><th>Fecha</th><th>Hora</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ======= DISPONIBILIDAD ======= -->
  <div id="dispView" class="card hidden">
    <button class="btn small ghost goBack">‚¨ÖÔ∏é Men√∫</button>
    <hr class="sep">
    <div class="row">
      <select id="d_tecnica"></select>
      <input id="d_fecha" type="date">
      <button class="btn small" id="btnVerDispon">Ver</button>
    </div>
    <div id="dispSlots" class="card"></div>
  </div>

  <!-- ======= NO SHOW ======= -->
  <div id="noshowView" class="card hidden">
    <button class="btn small ghost goBack">‚¨ÖÔ∏é Men√∫</button>
    <hr class="sep">
    <div class="hint">Marca una cita como ‚ÄúNo show‚Äù o ‚ÄúAsisti√≥‚Äù. Tambi√©n se auto-detectan pasadas sin check-in.</div>
    <table class="table" id="tblNoShow">
      <thead><tr><th>Cliente</th><th>Fecha</th><th>Hora</th><th>T√©cnica</th><th>Estado</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ======= COBROS / FACTURAS ======= -->
  <div id="cobrosView" class="card hidden">
    <div class="row">
      <button class="btn small ghost goBack">‚¨ÖÔ∏é Men√∫</button>
      <div class="pill">Al guardar ‚ûú se agrega autom√°ticamente a ‚ÄúHoja de cuadre diario‚Äù.</div>
    </div>
    <hr class="sep">
    <div class="grid">
      <div class="col-3"><div class="stack"><label>Cliente</label><input id="c_nombre" placeholder="Nombre"></div></div>
      <div class="col-3"><div class="stack"><label>Tel√©fono</label><input id="c_tel" placeholder="7871234567"></div></div>
      <div class="col-3"><div class="stack"><label>Servicio</label><select id="c_servicio"></select></div></div>
      <div class="col-3"><div class="stack"><label>Monto</label><input id="c_monto" type="number" step="0.01" placeholder="0.00"></div></div>
      <div class="col-3"><div class="stack"><label>M√©todo de pago</label>
        <select id="c_metodo">
          <option>ATH M√≥vil</option><option>Cash</option><option>Tarjeta</option><option>Transferencia</option><option>Cheque</option>
        </select></div>
      </div>
      <div class="col-3"><div class="stack"><label>Fecha</label><input id="c_fecha" type="date"></div></div>
      <div class="col-3"><div class="stack"><label>Hora</label><input id="c_hora" type="time"></div></div>
      <div class="col-3"><div class="stack"><label>Notas</label><input id="c_notas"></div></div>
      <div class="col-12 row">
        <button class="btn" id="btnGuardarCobro">Guardar cobro / factura</button>
        <button class="btn ghost" id="btnRecibo">Exportar recibo</button>
        <a class="btn ghost" id="btnWhatsCobro" target="_blank" rel="noopener">WhatsApp</a>
      </div>
    </div>
    <hr class="sep">
    <div class="row">
      <div class="pill">Historial de cobros</div>
      <button class="btn small ghost" id="expCobrosCSV">Exportar CSV</button>
    </div>
    <table class="table" id="tblCobros"><thead><tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Tel</th><th>Servicio</th><th>M√©todo</th><th>Monto</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- ======= RENDIMIENTO ======= -->
  <div id="rendView" class="card hidden">
    <button class="btn small ghost goBack">‚¨ÖÔ∏é Men√∫</button>
    <hr class="sep">
    <div class="row">
      <label>Desde</label><input id="r_desde" type="date">
      <label>Hasta</label><input id="r_hasta" type="date">
      <button class="btn small" id="btnRend">Calcular</button>
      <button class="btn small ghost" id="expRendCSV">Exportar CSV</button>
    </div>
    <div id="rendOut" class="card"></div>
  </div>

  <!-- ======= CONFIGURACI√ìN (solo admin) ======= -->
  <div id="configView" class="card hidden">
    <button class="btn small ghost goBack">‚¨ÖÔ∏é Men√∫</button>
    <hr class="sep">
    <div class="grid">
      <div class="col-6">
        <div class="section-title">Marca / Topbar & Bienvenida</div>
        <div class="stack"><label>Nombre del sal√≥n</label><input id="conf_name" placeholder="Sal√≥n de Belleza"></div>
        <div class="stack"><label>Logo (URL)</label><input id="conf_logo" placeholder="https://..."></div>
        <div class="stack"><label>Logo bienvenida (URL)</label><input id="conf_logo_w" placeholder="https://..."></div>
        <div class="stack"><label>Imagen de fondo bienvenida (URL transparente u otra)</label><input id="conf_bg" placeholder="https://..."></div>
      </div>
      <div class="col-6">
        <div class="section-title">Colores & Estilos</div>
        <div class="grid">
          <div class="col-6"><div class="stack"><label>Fondo (bg)</label><input id="c_bg" type="color" value="#0e1a24"></div></div>
          <div class="col-6"><div class="stack"><label>Panel</label><input id="c_panel" type="color" value="#0f2230"></div></div>
          <div class="col-6"><div class="stack"><label>Panel 2</label><input id="c_panel2" type="color" value="#0c1c28"></div></div>
          <div class="col-6"><div class="stack"><label>Texto</label><input id="c_ink" type="color" value="#e8f0f6"></div></div>
          <div class="col-6"><div class="stack"><label>Accent</label><input id="c_accent" type="color" value="#4cc2ff"></div></div>
          <div class="col-6"><div class="stack"><label>Bot√≥n</label><input id="c_btn" type="color" value="#1e88e5"></div></div>
          <div class="col-6"><div class="stack"><label>Texto bot√≥n</label><input id="c_btn_text" type="color" value="#ffffff"></div></div>
        </div>
        <div class="bg-preview" id="previewBg">Previsualizaci√≥n</div>
      </div>

      <div class="col-6">
        <div class="section-title">T√©cnicas / Estilistas</div>
        <div class="row">
          <input id="add_tecnica" placeholder="Nombre de la t√©cnica">
          <button class="btn small" id="btnAddTecnica">A√±adir</button>
        </div>
        <ul id="listTecnicas"></ul>
      </div>
      <div class="col-6">
        <div class="section-title">Servicios</div>
        <div class="grid">
          <div class="col-6"><input id="add_serv" placeholder="Servicio"></div>
          <div class="col-3"><input id="add_precio" type="number" step="0.01" placeholder="$"></div>
          <div class="col-3"><button class="btn small" id="btnAddServ">A√±adir</button></div>
          <div class="col-12"><ul id="listServ"></ul></div>
        </div>
      </div>

      <div class="col-6">
        <div class="section-title">Usuarios & Roles</div>
        <div class="row">
          <input id="u_user" placeholder="usuario">
          <input id="u_pass" placeholder="contrase√±a">
          <select id="u_role"><option>admin</option><option>usuario</option></select>
          <button class="btn small" id="btnAddUser">Crear/Actualizar</button>
        </div>
        <ul id="listUsers"></ul>
      </div>

      <div class="col-6">
        <div class="section-title">Recordatorios & Enlaces</div>
        <div class="stack"><label>Minutos recordatorio (antes de la cita)</label><input id="rem_min" type="number" value="1440"></div>
        <div class="stack"><label>WhatsApp prefijo pa√≠s (sin +)</label><input id="wa_cc" value="1"></div>
        <div class="stack"><label>URL Webhook Google Apps Script (opcional para enviar cobros a Sheets)</label><input id="gs_hook" placeholder="https://script.google.com/macros/s/.../exec"></div>
      </div>

      <div class="col-12 row">
        <button class="btn" id="btnGuardarConf">Guardar configuraci√≥n</button>
        <button class="btn ghost" id="btnResetConf">Restaurar valores por defecto</button>
      </div>
    </div>
  </div>

  <!-- ======= BACKUPS & EXPORTS ======= -->
  <div id="backupsView" class="card hidden">
    <button class="btn small ghost goBack">‚¨ÖÔ∏é Men√∫</button>
    <hr class="sep">
    <div class="grid">
      <div class="col-6">
        <div class="section-title">Exportar</div>
        <div class="row">
          <button class="btn small" id="expConfJSON">Config JSON</button>
          <button class="btn small" id="expTodoJSON">TODO JSON</button>
          <button class="btn small" id="expCitasCSV">Citas CSV</button>
          <button class="btn small" id="expNoShowCSV">NoShow CSV</button>
          <button class="btn small" id="expLoginCSV">Login CSV</button>
          <button class="btn small" id="expRendTodoCSV">Rendimiento CSV</button>
        </div>
        <div class="section-title" style="margin-top:12px">Backups autom√°ticos</div>
        <div class="row">
          <button class="btn small" data-bkp="daily" id="btnBkpDaily">Exportar diario</button>
          <button class="btn small" data-bkp="weekly" id="btnBkpWeekly">Exportar semanal</button>
          <button class="btn small" data-bkp="monthly" id="btnBkpMonthly">Exportar mensual</button>
          <button class="btn small" data-bkp="yearly" id="btnBkpYearly">Exportar anual</button>
        </div>
      </div>
      <div class="col-6">
        <div class="section-title">Importar / Restaurar</div>
        <input id="impFile" type="file" accept=".json,.csv">
        <div class="row">
          <button class="btn small" id="btnImpConf">Importar Config JSON</button>
          <button class="btn small" id="btnImpTodo">Restaurar TODO JSON</button>
        </div>
        <div class="hint">La importaci√≥n JSON reemplaza los datos locales. Se guardar√° un backup autom√°tico antes de restaurar.</div>
      </div>
    </div>
    <div class="sticky-foot">
      <div class="row"><div class="muted">Exporta y guarda tus copias en tu nube. Soporta funcionamiento offline.</div></div>
    </div>
  </div>

  <div class="foot center">
    <img id="logoFooter" alt="" src="" style="height:26px;vertical-align:middle"> <span id="footerName">Sal√≥n</span> ¬∑ <span id="yearSpan"></span> ¬∑ <span class="muted">PWA</span>
  </div>
</div>

<script>
/* =========================
   STORAGE & UTILIDADES
========================= */
const DBKEY = 'salon.app.v1';
const STATE = {
  session:null, // {user, role}
  data: {
    config:{
      name:'Sal√≥n de Belleza',
      logo:'', logoWelcome:'', welcomeBg:'',
      colors:{bg:'#0e1a24',panel:'#0f2230',panel2:'#0c1c28',ink:'#e8f0f6',accent:'#4cc2ff',btn:'#1e88e5',btn_text:'#ffffff'},
      waCC:'1',
      reminderMins:1440,
      gsHook:'' // Apps Script webhook opcional
    },
    users:{ /* user: {pass,role} */ },
    tecnicas:[], // ['Cynthia','Mar√≠a']
    servicios:[], // [{nombre:'Tinte',precio:40}]
    citas:[],     // [{id, nombre,tel,servicio,tecnica,fecha,hora,notas,estado:'pendiente'|'asisti√≥'|'no show', reminded:bool}]
    cobros:[],    // [{id, fecha,hora,nombre,tel,servicio,metodo,monto,notas}]
    logins:[],    // [{ts,user,ip?}]
  }
};
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const fmt = n => new Intl.NumberFormat('es-PR',{style:'currency',currency:'USD'}).format(Number(n||0));
const todayISO = () => new Date().toISOString().slice(0,10);
const nowHM = () => new Date().toTimeString().slice(0,5);
const uid = ()=>'id'+Math.random().toString(36).slice(2,10);

/* Load/Save */
function load(){
  const raw = localStorage.getItem(DBKEY);
  if(raw){ try{ STATE.data = JSON.parse(raw); }catch(e){} }
}
function save(){ localStorage.setItem(DBKEY, JSON.stringify(STATE.data)); }

/* Apply theme and branding */
function applyBrand(){
  const c = STATE.data.config.colors;
  document.documentElement.style.setProperty('--bg', c.bg);
  document.documentElement.style.setProperty('--panel', c.panel);
  document.documentElement.style.setProperty('--panel-2', c.panel2);
  document.documentElement.style.setProperty('--ink', c.ink);
  document.documentElement.style.setProperty('--accent', c.accent);
  document.documentElement.style.setProperty('--btn', c.btn);
  document.documentElement.style.setProperty('--btn-text', c.btn_text);
  $('#salonName').textContent = STATE.data.config.name || 'Sal√≥n de Belleza';
  $('#footerName').textContent = STATE.data.config.name || 'Sal√≥n';
  $('#logoHeader').src = STATE.data.config.logo || '';
  $('#logoFooter').src = STATE.data.config.logo || '';
  $('#logoWelcome').src = STATE.data.config.logoWelcome || (STATE.data.config.logo||'');
  const bg = STATE.data.config.welcomeBg ? `url(${STATE.data.config.welcomeBg})` : 'none';
  $('#welcomeBg').style.backgroundImage = bg;
}

/* Router simple */
function show(id){
  for(const v of ['welcomeView','dashboardView','agendaView','dispView','noshowView','cobrosView','rendView','configView','backupsView']){
    (document.getElementById(v)||{}).classList.add('hidden');
  }
  document.getElementById(id).classList.remove('hidden');
}

/* Roles */
function applyRole(){
  $$('.adminOnly').forEach(el => {
    el.classList.toggle('hidden', !(STATE.session && STATE.session.role==='admin'));
  });
}

/* Seed admin if empty */
function ensureAdmin(){
  if(Object.keys(STATE.data.users).length===0){
    STATE.data.users['admin']={pass:'admin',role:'admin'};
    save();
  }
}

/* =========================
   INICIALIZACI√ìN
========================= */
load(); ensureAdmin(); applyBrand();
$('#yearSpan').textContent = new Date().getFullYear();

/* Session */
function login(u,p){
  const rec = STATE.data.users[u];
  if(rec && rec.pass===p){
    STATE.session = {user:u, role:rec.role};
    STATE.data.logins.push({ts:Date.now(),user:u});
    save(); applyRole();
    show('dashboardView');
    return true;
  }
  return false;
}

/* Eventos Topbar */
$('#btnDashboard').onclick=()=> show(STATE.session ? 'dashboardView':'welcomeView');

/* Welcome actions */
$('#btnLogin').onclick=()=>{
  const ok = login($('#loginUser').value.trim(), $('#loginPass').value);
  if(!ok) alert('Usuario o contrase√±a inv√°lidos');
};
$('#btnSeedAdmin').onclick=()=>{
  ensureAdmin();
  alert('Usuario admin creado (admin / admin). Cambia la contrase√±a en Configuraci√≥n.');
};

/* Go back buttons */
$$('.goBack').forEach(b=> b.onclick=()=> show('dashboardView'));

/* Menu navegacion */
$('#goAgenda').onclick=()=>{fillSelects(); refreshCitas(); show('agendaView');};
$('#goDisponibilidad').onclick=()=>{fillSelects(); $('#d_fecha').value=todayISO(); show('dispView');};
$('#goNoShow').onclick=()=>{refreshNoShow(); show('noshowView');};
$('#goCobros').onclick=()=>{fillSelects(); $('#c_fecha').value=todayISO(); $('#c_hora').value=nowHM(); refreshCobros(); show('cobrosView');};
$('#goRendimiento').onclick=()=>{$('#r_desde').value=todayISO(); $('#r_hasta').value=todayISO(); $('#rendOut').innerHTML=''; show('rendView');};
$('#goConfig').onclick=()=>{loadConfigUI(); show('configView');};
$('#goBackups').onclick=()=> show('backupsView');

$('#openSheets').onclick=()=>{}; // (link ya es <a>)

/* =========================
   AGENDA: crear/editar, duplicado, GCAL, WhatsApp
========================= */
function fillSelects(){
  const t = STATE.data.tecnicas; const s=STATE.data.servicios;
  const selT = [$('#a_tecnica'), $('#d_tecnica')];
  selT.forEach(sel=>{ sel.innerHTML=''; t.forEach(x=>{const o=document.createElement('option');o.textContent=x;o.value=x; sel.appendChild(o);}); });
  const selS = [$('#a_servicio'), $('#c_servicio')];
  selS.forEach(sel=>{ sel.innerHTML=''; s.forEach(x=>{const o=document.createElement('option');o.textContent=`${x.nombre} (${fmt(x.precio)})`;o.value=x.nombre; sel.appendChild(o);}); });
}

function citaDup(nombre,tel,tecnica,fecha,hora, excludeId=null){
  const key = `${nombre}|${tel}|${tecnica}|${fecha}|${hora}`;
  return STATE.data.citas.some(c=> (excludeId? c.id!==excludeId : true) && `${c.nombre}|${c.tel}|${c.tecnica}|${c.fecha}|${c.hora}`===key);
}

function crearCita(obj){
  if(citaDup(obj.nombre,obj.tel,obj.tecnica,obj.fecha,obj.hora)) return {ok:false,reason:'Duplicada'};
  obj.id = uid(); obj.estado='pendiente'; obj.reminded=false;
  STATE.data.citas.push(obj); save(); return {ok:true,id:obj.id};
}
function updateCita(id,patch){
  const i = STATE.data.citas.findIndex(c=>c.id===id);
  if(i<0) return false;
  const target = {...STATE.data.citas[i], ...patch};
  if(citaDup(target.nombre,target.tel,target.tecnica,target.fecha,target.hora, id)) { alert('Quedar√≠a duplicada con otra cita.'); return false; }
  STATE.data.citas[i]=target; save(); return true;
}
function delCita(id){
  STATE.data.citas = STATE.data.citas.filter(c=>c.id!==id); save();
}

function refreshCitas(list=STATE.data.citas){
  const tb = $('#tblCitas tbody'); tb.innerHTML='';
  list.sort((a,b)=> (a.fecha+a.hora).localeCompare(b.fecha+b.hora));
  for(const c of list){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.nombre}</td>
      <td>${c.tel}</td>
      <td>${c.servicio}</td>
      <td>${c.tecnica}</td>
      <td>${c.fecha}</td>
      <td>${c.hora}</td>
      <td>${c.estado}</td>
      <td class="row">
        <button class="btn small ghost" data-act="edit" data-id="${c.id}">‚úèÔ∏è</button>
        <button class="btn small ghost" data-act="gcal" data-id="${c.id}">üóìÔ∏è</button>
        <a class="btn small ghost" data-act="wa" data-id="${c.id}" target="_blank" rel="noopener">üü¢</a>
        <button class="btn small ghost" data-act="ok" data-id="${c.id}">‚úîÔ∏è</button>
        <button class="btn small ghost" data-act="ns" data-id="${c.id}">‚õî</button>
        <button class="btn small ghost danger" data-act="del" data-id="${c.id}">üóëÔ∏è</button>
      </td>`;
    tb.appendChild(tr);
  }
}

$('#btnCrearCita').onclick=()=>{
  const obj = {
    nombre:$('#a_nombre').value.trim(), tel:$('#a_tel').value.trim(),
    tecnica:$('#a_tecnica').value, servicio:$('#a_servicio').value,
    fecha:$('#a_fecha').value, hora:$('#a_hora').value, notas:$('#a_notas').value.trim()
  };
  if(!obj.nombre||!obj.tel||!obj.tecnica||!obj.servicio||!obj.fecha||!obj.hora){ alert('Completa todos los campos.'); return; }
  const res=crearCita(obj);
  if(!res.ok){ alert('Cita duplicada. Cambia hora o t√©cnica.'); return; }
  refreshCitas();
  // limpiar
  $('#a_notas').value='';
  // activar edici√≥n inmediata
  editingId = res.id; $('#btnEditarCita').disabled=false;
  alert('Cita creada.');
};

let editingId = null;
$('#btnEditarCita').onclick=()=>{
  if(!editingId) return;
  const patch = {
    nombre:$('#a_nombre').value.trim(), tel:$('#a_tel').value.trim(),
    tecnica:$('#a_tecnica').value, servicio:$('#a_servicio').value,
    fecha:$('#a_fecha').value, hora:$('#a_hora').value, notas:$('#a_notas').value.trim()
  };
  if(updateCita(editingId,patch)){ refreshCitas(); alert('Cita actualizada.'); }
};

$('#filtroCitas').oninput=(e)=>{
  const q = e.target.value.toLowerCase();
  const list = STATE.data.citas.filter(c=> (c.nombre+c.tel+c.fecha).toLowerCase().includes(q));
  refreshCitas(list);
};

$('#tblCitas').onclick=(e)=>{
  const btn = e.target.closest('button, a'); if(!btn) return;
  const id = btn.getAttribute('data-id');
  const act = btn.getAttribute('data-act');
  const c = STATE.data.citas.find(x=>x.id===id); if(!c) return;
  if(act==='edit'){
    editingId=id;
    $('#a_nombre').value=c.nombre; $('#a_tel').value=c.tel; $('#a_tecnica').value=c.tecnica;
    $('#a_servicio').value=c.servicio; $('#a_fecha').value=c.fecha; $('#a_hora').value=c.hora; $('#a_notas').value=c.notas||'';
    $('#btnEditarCita').disabled=false; window.scrollTo({top:0,behavior:'smooth'});
  }
  if(act==='gcal'){
    // Crear URL Google Calendar
    const start = new Date(`${c.fecha}T${c.hora}:00`);
    const end = new Date(start.getTime()+60*60*1000);
    const pad = n=> String(n).padStart(2,'0');
    const iso = d=> `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}00Z`;
    const details = encodeURIComponent(`${c.servicio} con ${c.tecnica}\nNotas: ${c.notas||''}\nTel: ${c.tel}`);
    const text = encodeURIComponent(`Cita: ${c.servicio} ‚Äì ${c.nombre}`);
    const loc  = encodeURIComponent(STATE.data.config.name);
    const url = `https://calendar.google.com/calendar/u/0/r/eventedit?text=${text}&dates=${iso(start)}/${iso(end)}&details=${details}&location=${loc}`;
    window.open(url,'_blank');
  }
  if(act==='wa'){
    const cc = STATE.data.config.waCC||'1';
    const msg = encodeURIComponent(`Hola ${c.nombre}, tu cita de ${c.servicio} fue agendada para el ${c.fecha} a las ${c.hora} con ${c.tecnica}. Si deseas reprogramar, resp√≥ndenos por aqu√≠. ¬°Gracias!`);
    const link = `https://wa.me/${cc}${c.tel.replace(/\D/g,'')}?text=${msg}`;
    btn.href = link;
  }
  if(act==='ok'){ c.estado='asisti√≥'; save(); refreshCitas(); refreshNoShow(); }
  if(act==='ns'){ c.estado='no show'; save(); refreshCitas(); refreshNoShow(); }
  if(act==='del'){ if(confirm('¬øEliminar cita?')){ delCita(id); refreshCitas(); refreshNoShow(); } }
};

/* Disponibilidad: slots de 8:00‚Äì17:00 cada 30m */
function genSlots(){ const out=[]; for(let h=8;h<=17;h++){ for(let m=0;m<60;m+=30){ out.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`); } } return out; }
$('#btnVerDispon').onclick=()=>{
  const t = $('#d_tecnica').value, f = $('#d_fecha').value;
  const book = new Set(STATE.data.citas.filter(c=>c.tecnica===t && c.fecha===f).map(c=>c.hora));
  const slots = genSlots().map(h=> book.has(h) ? `‚ùå ${h}` : `‚úÖ ${h}`);
  $('#dispSlots').innerHTML = `<div class="stack"><b>${t}</b> ‚Äì ${f}</div><div class="grid">`+
    slots.map(s=>`<div class="col-3"><div class="card center">${s}</div></div>`).join('')+`</div>`;
};

/* No show */
function refreshNoShow(){
  const tb = $('#tblNoShow tbody'); tb.innerHTML='';
  const list = STATE.data.citas.slice().sort((a,b)=> (a.fecha+a.hora).localeCompare(b.fecha+b.hora));
  for(const c of list){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.nombre}</td><td>${c.fecha}</td><td>${c.hora}</td><td>${c.tecnica}</td><td>${c.estado}</td>
    <td class="row">
      <button class="btn small ghost" data-ns="ok" data-id="${c.id}">‚úîÔ∏è Asisti√≥</button>
      <button class="btn small ghost" data-ns="ns" data-id="${c.id}">‚õî No show</button>
    </td>`;
    tb.appendChild(tr);
  }
}
$('#tblNoShow').onclick=(e)=>{
  const b = e.target.closest('button'); if(!b) return;
  const id=b.getAttribute('data-id'); const act=b.getAttribute('data-ns');
  const c=STATE.data.citas.find(x=>x.id===id); if(!c) return;
  c.estado = (act==='ok'?'asisti√≥':'no show'); save(); refreshNoShow(); refreshCitas();
};

/* =========================
   COBROS / FACTURAS
========================= */
function refreshCobros(){
  const tb = $('#tblCobros tbody'); tb.innerHTML='';
  const list = STATE.data.cobros.slice().sort((a,b)=> (b.fecha+b.hora).localeCompare(a.fecha+a.hora));
  for(const r of list){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.fecha}</td><td>${r.hora}</td><td>${r.nombre}</td><td>${r.tel}</td><td>${r.servicio}</td><td>${r.metodo}</td><td>${fmt(r.monto)}</td>`;
    tb.appendChild(tr);
  }
}

async function enviarAGoogleSheets(row){
  const hook = STATE.data.config.gsHook;
  if(!hook) return; // opcional
  try{
    await fetch(hook,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tipo:'cobro',row})});
  }catch(e){ console.log('Apps Script error/omiso',e); }
}
$('#btnGuardarCobro').onclick=()=>{
  const rec={
    id:uid(), fecha:$('#c_fecha').value||todayISO(), hora:$('#c_hora').value||nowHM(),
    nombre:$('#c_nombre').value.trim(), tel:$('#c_tel').value.trim(),
    servicio:$('#c_servicio').value, metodo:$('#c_metodo').value,
    monto:Number($('#c_monto').value||0), notas:$('#c_notas').value.trim()
  };
  if(!rec.nombre||!rec.tel||!rec.servicio||!rec.metodo||!rec.monto){ alert('Completa los campos requeridos.'); return; }
  STATE.data.cobros.push(rec); save(); refreshCobros();
  enviarAGoogleSheets({fecha:rec.fecha,hora:rec.hora,nombre:rec.nombre,tel:rec.tel,servicio:rec.servicio,metodo:rec.metodo,monto:rec.monto,notas:rec.notas});
  alert('Cobro guardado y enviado a Hoja de cuadre (si configuraste Apps Script).');
};
$('#btnRecibo').onclick=()=>{
  const nombre=$('#c_nombre').value||'Cliente';
  const tel=$('#c_tel').value||'';
  const srv=$('#c_servicio').value||'Servicio';
  const mtd=$('#c_metodo').value||'M√©todo';
  const monto=$('#c_monto').value||'0.00';
  const fecha=$('#c_fecha').value||todayISO();
  const hora=$('#c_hora').value||nowHM();
  const salon=STATE.data.config.name;
  const html = `Recibo ‚Äì ${salon}\nCliente: ${nombre}\nTel: ${tel}\nServicio: ${srv}\nM√©todo: ${mtd}\nMonto: ${fmt(monto)}\nFecha: ${fecha} ${hora}`;
  const blob = new Blob([html],{type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`recibo_${fecha}_${nombre}.txt`; a.click(); URL.revokeObjectURL(url);
  const msg = encodeURIComponent(`Recibo ${salon}%0A${html.replace(/\n/g,'%0A')}`);
  $('#btnWhatsCobro').href=`https://wa.me/${(STATE.data.config.waCC||'1')}${String(tel).replace(/\D/g,'')}?text=${msg}`;
};

/* =========================
   RENDIMIENTO
========================= */
$('#btnRend').onclick=()=>{
  const d=$('#r_desde').value||todayISO(), h=$('#r_hasta').value||todayISO();
  const inRange = (f)=> f>=d && f<=h;
  const citas=STATE.data.citas.filter(c=>inRange(c.fecha));
  const cobros=STATE.data.cobros.filter(c=>inRange(c.fecha));
  const totalCobros=cobros.reduce((a,b)=>a+Number(b.monto||0),0);
  const ns=citas.filter(c=>c.estado==='no show').length;
  const asist=citas.filter(c=>c.estado==='asisti√≥').length;
  const pend=citas.filter(c=>c.estado==='pendiente').length;
  $('#rendOut').innerHTML=`
    <div class="grid">
      <div class="col-3 card center"><div class="section-title">Citas</div><div>${citas.length}</div></div>
      <div class="col-3 card center"><div class="section-title">Asisti√≥</div><div class="ok">${asist}</div></div>
      <div class="col-3 card center"><div class="section-title">No show</div><div class="danger">${ns}</div></div>
      <div class="col-3 card center"><div class="section-title">Pendientes</div><div class="warn">${pend}</div></div>
      <div class="col-12 card center"><div class="section-title">Cobrado</div><div style="font-size:24px">${fmt(totalCobros)}</div></div>
    </div>`;
};
$('#expRendCSV').onclick=()=>{
  const rows=[['desde','hasta',$('#r_desde').value,$('#r_hasta').value],[],['tipo','fecha','monto']];
  STATE.data.cobros.forEach(r=> rows.push(['cobro',r.fecha,r.monto]));
  downloadCSV('rendimiento.csv', rows);
};

/* =========================
   CONFIGURACI√ìN
========================= */
function loadConfigUI(){
  $('#conf_name').value = STATE.data.config.name;
  $('#conf_logo').value = STATE.data.config.logo;
  $('#conf_logo_w').value = STATE.data.config.logoWelcome||'';
  $('#conf_bg').value = STATE.data.config.welcomeBg||'';
  const c=STATE.data.config.colors;
  $('#c_bg').value=c.bg; $('#c_panel').value=c.panel; $('#c_panel2').value=c.panel2; $('#c_ink').value=c.ink; $('#c_accent').value=c.accent; $('#c_btn').value=c.btn; $('#c_btn_text').value=c.btn_text;
  $('#previewBg').style.backgroundImage = STATE.data.config.welcomeBg?`url(${STATE.data.config.welcomeBg})`:'none';
  // listas
  renderList('#listTecnicas', STATE.data.tecnicas, (i)=>{ STATE.data.tecnicas.splice(i,1); save(); loadConfigUI(); });
  renderList('#listServ', STATE.data.servicios.map(s=>`${s.nombre} ‚Äì ${fmt(s.precio)}`), (i)=>{ STATE.data.servicios.splice(i,1); save(); loadConfigUI(); });
  renderList('#listUsers', Object.entries(STATE.data.users).map(([u,v])=>`${u} (${v.role})`), (i)=>{
    const k = Object.keys(STATE.data.users)[i]; delete STATE.data.users[k]; save(); loadConfigUI();
  });
  $('#wa_cc').value=STATE.data.config.waCC||'1';
  $('#rem_min').value=STATE.data.config.reminderMins||1440;
  $('#gs_hook').value=STATE.data.config.gsHook||'';
}
function renderList(sel, arr, onDel){
  const ul=$(sel); ul.innerHTML='';
  arr.forEach((txt,i)=>{
    const li=document.createElement('li'); li.className='row'; li.style.justifyContent='space-between';
    li.innerHTML=`<span>${txt}</span><button class="btn small ghost">Eliminar</button>`;
    li.querySelector('button').onclick=()=> onDel(i);
    ul.appendChild(li);
  });
}
$('#btnAddTecnica').onclick=()=>{ const v=$('#add_tecnica').value.trim(); if(!v) return; STATE.data.tecnicas.push(v); save(); $('#add_tecnica').value=''; loadConfigUI(); };
$('#btnAddServ').onclick=()=>{ const n=$('#add_serv').value.trim(); const p=Number($('#add_precio').value||0); if(!n) return; STATE.data.servicios.push({nombre:n,precio:p}); save(); $('#add_serv').value=''; $('#add_precio').value=''; loadConfigUI(); };
$('#btnAddUser').onclick=()=>{
  const u=$('#u_user').value.trim(), p=$('#u_pass').value, r=$('#u_role').value;
  if(!u||!p) return alert('Usuario y contrase√±a requeridos');
  STATE.data.users[u]={pass:p,role:r}; save(); loadConfigUI(); alert('Usuario guardado.');
};
$('#btnGuardarConf').onclick=()=>{
  STATE.data.config.name=$('#conf_name').value||'Sal√≥n';
  STATE.data.config.logo=$('#conf_logo').value||'';
  STATE.data.config.logoWelcome=$('#conf_logo_w').value||'';
  STATE.data.config.welcomeBg=$('#conf_bg').value||'';
  STATE.data.config.colors={
    bg:$('#c_bg').value,panel:$('#c_panel').value,panel2:$('#c_panel2').value,ink:$('#c_ink').value,accent:$('#c_accent').value,btn:$('#c_btn').value,btn_text:$('#c_btn_text').value
  };
  STATE.data.config.waCC = $('#wa_cc').value||'1';
  STATE.data.config.reminderMins = Number($('#rem_min').value||1440);
  STATE.data.config.gsHook = $('#gs_hook').value||'';
  save(); applyBrand(); alert('Configuraci√≥n guardada.');
};
$('#btnResetConf').onclick=()=>{
  if(!confirm('¬øRestaurar configuraci√≥n por defecto?')) return;
  STATE.data.config={name:'Sal√≥n de Belleza',logo:'',logoWelcome:'',welcomeBg:'',colors:{bg:'#0e1a24',panel:'#0f2230',panel2:'#0c1c28',ink:'#e8f0f6',accent:'#4cc2ff',btn:'#1e88e5',btn_text:'#ffffff'}, waCC:'1',reminderMins:1440,gsHook:''};
  save(); applyBrand(); loadConfigUI();
};

/* =========================
   BACKUPS / EXPORTS / IMPORTS
========================= */
function download(filename, blob){
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
function downloadCSV(name, rows){
  const csv = rows.map(r=> r.map(x=> `"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  download(name,new Blob([csv],{type:'text/csv;charset=utf-8;'}));
}
$('#expConfJSON').onclick=()=> download('config.json', new Blob([JSON.stringify(STATE.data.config,null,2)],{type:'application/json'}));
$('#expTodoJSON').onclick=()=> download('backup_todo.json', new Blob([JSON.stringify(STATE.data,null,2)],{type:'application/json'}));
$('#expCitasCSV').onclick=()=>{
  const rows=[['id','nombre','tel','servicio','tecnica','fecha','hora','estado','notas']];
  STATE.data.citas.forEach(c=> rows.push([c.id,c.nombre,c.tel,c.servicio,c.tecnica,c.fecha,c.hora,c.estado,c.notas||'']));
  downloadCSV('citas.csv', rows);
};
$('#expNoShowCSV').onclick=()=>{
  const rows=[['id','nombre','fecha','hora','tecnica','estado']];
  STATE.data.citas.filter(c=>c.estado==='no show').forEach(c=> rows.push([c.id,c.nombre,c.fecha,c.hora,c.tecnica,c.estado]));
  downloadCSV('noshow.csv', rows);
};
$('#expLoginCSV').onclick=()=>{
  const rows=[['timestamp','usuario']]; STATE.data.logins.forEach(l=> rows.push([new Date(l.ts).toISOString(), l.user]));
  downloadCSV('logins.csv', rows);
};
$('#expRendTodoCSV').onclick=()=>{
  const rows=[['tipo','fecha','hora','nombre','tel','servicio','extra','monto']];
  STATE.data.citas.forEach(c=> rows.push(['cita',c.fecha,c.hora,c.nombre,c.tel,c.servicio,c.estado,'']));
  STATE.data.cobros.forEach(r=> rows.push(['cobro',r.fecha,r.hora,r.nombre,r.tel,r.servicio,r.metodo,r.monto]));
  downloadCSV('rend_todo.csv', rows);
};
/* Exportador r√°pido Cobros (desde vista Cobros) */
$('#expCobrosCSV').onclick=()=>{
  const rows=[['fecha','hora','cliente','tel','servicio','metodo','monto','notas']];
  STATE.data.cobros.forEach(r=> rows.push([r.fecha,r.hora,r.nombre,r.tel,r.servicio,r.metodo,r.monto,r.notas||'']));
  downloadCSV('cobros.csv', rows);
}

/* Importar */
let fileCache=null;
$('#impFile').onchange=(e)=>{ fileCache=e.target.files[0]||null; };
$('#btnImpConf').onclick=()=>importJSON('conf');
$('#btnImpTodo').onclick=()=>importJSON('todo');
async function importJSON(kind){
  if(!fileCache){ alert('Selecciona un archivo JSON'); return; }
  const txt = await fileCache.text();
  try{
    const obj = JSON.parse(txt);
    // Backup previo
    download('pre_restore_backup.json', new Blob([JSON.stringify(STATE.data,null,2)],{type:'application/json'}));
    if(kind==='conf'){ STATE.data.config = obj; }
    else { STATE.data = obj; }
    save(); applyBrand(); alert('Importado. Recarga si no ves los cambios.');
  }catch(e){ alert('Archivo inv√°lido'); }
}

/* =========================
   RECORDATORIOS 24h
========================= */
async function askNotif(){ try{ if(Notification.permission==='default') await Notification.requestPermission(); }catch(e){} }
function tickReminders(){
  const mins = STATE.data.config.reminderMins||1440;
  const now = Date.now();
  for(const c of STATE.data.citas){
    if(c.estado!=='pendiente'||c.reminded) continue;
    const ts = Date.parse(`${c.fecha}T${c.hora}:00`);
    if(isFinite(ts)){
      const diffMin = (ts - now)/60000;
      if(diffMin<=mins && diffMin>0){
        try{
          if(Notification.permission==='granted'){
            new Notification(`Recordatorio de cita ‚Äì ${c.nombre}`, {body:`${c.servicio} con ${c.tecnica} a las ${c.hora} (${c.fecha})`});
          } else {
            console.log('Recordatorio:', c);
          }
        }catch(e){}
        c.reminded=true; save();
      }
    }
  }
}
askNotif(); setInterval(tickReminders, 60*1000); // verifica cada minuto

/* =========================
   AUTO no-show (simple)
========================= */
setInterval(()=> {
  const now = new Date();
  const isoNow = now.toISOString().slice(0,16);
  for(const c of STATE.data.citas){
    if(c.estado==='pendiente'){
      const when = `${c.fecha}T${c.hora}`;
      if(when < isoNow){ c.estado='no show'; }
    }
  }
  save();
}, 5*60*1000);

/* =========================
   LOGIN INICIAL / REDIBUJAR
========================= */
applyRole();
if(STATE.session){ show('dashboardView'); } else { show('welcomeView'); }

/* =========================
   PWA: registrar SW
========================= */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }

/* =========================
   UI helpers varios
========================= */
function setBgPreview(){ $('#previewBg').style.backgroundImage = STATE.data.config.welcomeBg?`url(${STATE.data.config.welcomeBg})`:'none'; }
['conf_bg'].forEach(id=> { const el=$('#'+id); if(el) el.oninput=()=>{ STATE.data.config.welcomeBg = el.value; setBgPreview(); }; });

/* Accesos directos */
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){ show('dashboardView'); }
});
</script>
</body>
</html>
