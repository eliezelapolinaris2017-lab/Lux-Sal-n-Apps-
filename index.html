<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LuxSalon ‚Äì Agenda & Servicios</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111827">
<link rel="apple-touch-icon" href="icons/luxsalon-192.png">

<style>
:root{
  /* Paleta editable (se puede cambiar desde Config) */
  --bg:#0d1117;
  --ink:#e9f1f6;
  --muted:#a6bdcc;
  --panel:#121a24;
  --panel2:#0f1620;
  --line:#24384a;
  --accent:#4cc2ff;
  --ok:#32d296;
  --warn:#ffd35a;
  --danger:#ff5678;
  --topbar:#111827;
  --footer:#111827;
  --btn-bg:#15263a;
  --btn-border:#2a4157;
  --font: system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--ink);background:var(--bg) center/cover fixed no-repeat;
  font:15px/1.45 var(--font);
}
/* Scrollbar */
*::-webkit-scrollbar{width:12px;height:12px}
*::-webkit-scrollbar-thumb{background:#2a3d50;border-radius:10px;border:2px solid #0c1723}
*::-webkit-scrollbar-track{background:#0c1723}
a{color:inherit}
.hidden{display:none !important}

/* Topbar minimal: logo + nombre + Dashboard */
.topbar{
  position:sticky;top:0;z-index:20;background:var(--topbar);border-bottom:1px solid var(--line);
  display:flex;align-items:center;gap:.8rem;padding:.55rem .9rem
}
.topbar img{height:28px;width:auto;border-radius:6px;background:#0003;padding:2px}
.topbar h1{margin:0;font-size:15px;font-weight:600;letter-spacing:.2px}
.topbar .spacer{flex:1}

/* Botones */
.btn{
  padding:.6rem .85rem;border-radius:10px;border:1px solid var(--btn-border);
  background:var(--btn-bg);color:var(--ink);cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:.45rem
}
.btn:hover{filter:brightness(1.07)}
.btn.ok{background:#103125;border-color:#2a5d4a}
.btn.warn{background:#2b2300;border-color:#6b5600}
.btn.danger{background:#2b0e13;border-color:#6b2433}
.btn.accent{background:#103042;border-color:#285a73}
.btn.ghost{background:transparent;border-color:var(--line)}
.btn.icon{min-width:44px;justify-content:center}

.container{max-width:1080px;margin:16px auto;padding:0 16px}
.card{
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--line);border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 10px 30px #0005
}
h2{font-size:18px;margin:.2rem 0 1rem 0}
.title{display:flex;align-items:center;gap:.6rem;margin:0 0 .6rem 0}
.title .emoji{font-size:22px}
label{display:block;margin:.55rem 0 .3rem;color:var(--muted);font-size:13px}
input,select,textarea{
  width:100%;padding:.62rem .7rem;border-radius:10px;border:1px solid var(--line);background:#0d1a28;color:var(--ink)
}
textarea{min-height:90px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.list{display:grid;gap:10px}
.item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0a1723}
.mini{font-size:12px;color:#b8c9d8}
.pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:.2rem .6rem;font-size:12px;color:#b9d7ea}
.help{font-size:12px;color:#9fb4c6}
.center{text-align:center}
.mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}

/* Men√∫ vertical con iconos + orden configurable */
.menu-list{display:grid;gap:12px}
.menu-btn{
  display:flex;align-items:center;gap:12px;padding:14px;border:1px solid var(--line);
  border-radius:14px;background:#0c1a27;text-decoration:none;cursor:pointer
}
.menu-btn .icon{font-size:22px}
.menu-btn .txt{display:flex;flex-direction:column}
.menu-btn .txt b{font-size:16px}
.menu-btn .txt span{font-size:12px;color:#a7bdd0}

/* Footer */
.foot{margin:30px 0 10px;padding:16px;text-align:center;color:#9fb4c6;background:var(--footer);border:1px solid var(--line);border-radius:14px}

/* Bot√≥n flotante volver arriba/men√∫ */
.backtop{position:fixed;bottom:18px;right:18px;z-index:30}

/* Welcome/KPIs */
.welcome{padding:28px 16px;text-align:center}
.welcome img{height:86px;width:auto;border-radius:10px;background:#0003;padding:4px;margin-bottom:10px}
.kpis{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px}
.kpi{background:#0b1724;border:1px solid var(--line);border-radius:12px;padding:12px}
.kpi b{font-size:22px;display:block}

@media (max-width:760px){
  .row{grid-template-columns:1fr}
  .row3{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <img id="tbLogo" alt="logo">
  <h1 id="tbTitle">LuxSalon ‚Äì Agenda & Servicios</h1>
  <span class="spacer"></span>
  <button class="btn" onclick="location.hash='#menu'">Dashboard</button>
</div>

<div class="container">

  <!-- LOGIN -->
  <section id="login" class="card">
    <div class="welcome">
      <img id="welcomeLogo" alt="logo">
      <h2 id="welcomeTitle">Bienvenido(a) a LuxSalon</h2>
      <p class="mini">Inicia sesi√≥n para continuar. (default: <b>admin / admin</b>)</p>
    </div>
    <div class="row">
      <div><label>Usuario</label><input id="loginUser" autocomplete="username"></div>
      <div><label>Contrase√±a</label><input id="loginPass" type="password" autocomplete="current-password"></div>
    </div>
    <div class="mt12">
      <button class="btn ok" onclick="doLogin()">Entrar</button>
    </div>
  </section>

  <!-- MEN√ö (orden configurable) -->
  <section id="menu" class="card hidden">
    <h2 class="title"><span class="emoji">üìã</span> Men√∫ principal</h2>
    <div id="menuList" class="menu-list"></div>
  </section>

  <!-- BIENVENIDA / KPIs -->
  <section id="home" class="card hidden">
    <div class="welcome">
      <img id="homeLogo" alt="logo">
      <h2 id="homeTitle">LuxSalon</h2>
      <p class="mini">Usa el men√∫ para comenzar.</p>
      <div class="kpis mt12">
        <div class="kpi"><div class="mini">Citas de hoy</div><b id="kpiHoy">0</b><div class="mini" id="kpiProx"></div></div>
        <div class="kpi"><div class="mini">Mes (programadas)</div><b id="kpiMes">0</b><div class="mini">No-Show: <b id="kpiNoShow">0</b></div></div>
        <div class="kpi"><div class="mini">Ingresos (hoy)</div><b id="kpiIngresos">0.00</b><div class="mini">Tickets: <b id="kpiTickets">0</b></div></div>
        <div class="kpi"><div class="mini">T√©cnicas activas</div><b id="kpiTecnicas">0</b></div>
      </div>
    </div>
  </section>

  <!-- AGENDAR -->
  <section id="agendar" class="card hidden">
    <h2 class="title"><span class="emoji">üóìÔ∏è</span> Agendar cita</h2>
    <div class="row">
      <div><label>Cliente</label><input id="aNombre" placeholder="Nombre y apellido"></div>
      <div><label>Tel√©fono (WhatsApp)</label><input id="aTel" placeholder="7871234567"></div>
    </div>
    <div class="row">
      <div><label>Servicio</label><input id="aServicio" placeholder="Corte, color, blower‚Ä¶"></div>
      <div><label>T√©cnica/Estilista</label><select id="aTecnica"></select></div>
    </div>
    <div class="row">
      <div><label>Fecha y hora</label><input id="aFecha" type="datetime-local"></div>
      <div><label>Duraci√≥n (min)</label><input id="aDur" type="number" min="15" step="15" value="60"></div>
    </div>
    <label>Notas</label><textarea id="aNotas" placeholder="Detalles‚Ä¶"></textarea>
    <div class="mt12">
      <button class="btn ok" onclick="crearCita()">Crear cita</button>
      <a id="gcalLink" class="btn accent hidden" target="_blank">Abrir en Google Calendar</a>
      <a id="waLink" class="btn ok hidden" target="_blank">Abrir WhatsApp</a>
    </div>
    <h2 class="mt16">Citas programadas</h2>
    <div id="listaCitas" class="list"></div>

    <div class="mt12">
      <button class="btn" onclick="exportar('citas','csv')">Exportar citas (CSV)</button>
      <button class="btn" onclick="exportar('citas','json')">Exportar citas (JSON)</button>
    </div>
  </section>

  <!-- DISPONIBLES -->
  <section id="disponibles" class="card hidden">
    <h2 class="title"><span class="emoji">‚úÖ</span> Fechas disponibles</h2>
    <div class="row">
      <div><label>D√≠a</label><input id="dDia" type="date"></div>
      <div><label>Duraci√≥n deseada (min)</label><input id="dDur" type="number" min="15" step="15" value="60"></div>
    </div>
    <div class="mt12">
      <button class="btn" onclick="calcDisponibles()">Ver disponibles</button>
      <span class="help">Horario editable en Configuraci√≥n.</span>
    </div>
    <div id="listDisponibles" class="list mt12"></div>
  </section>

  <!-- NO-SHOW -->
  <section id="noshow" class="card hidden">
    <h2 class="title"><span class="emoji">üö´</span> No-Show</h2>
    <div id="listNoShow" class="list"></div>
    <div class="mt12">
      <button class="btn" onclick="exportar('noshow','csv')">Exportar No-Show (CSV)</button>
      <button class="btn" onclick="exportar('noshow','json')">Exportar No-Show (JSON)</button>
    </div>
  </section>

  <!-- RECORDATORIOS -->
  <section id="recordatorios" class="card hidden">
    <h2 class="title"><span class="emoji">‚è∞</span> Recordatorios 24h</h2>
    <p class="mini">Pulsa para abrir WhatsApp con el mensaje.</p>
    <div id="listRecordatorios" class="list"></div>
    <div class="mt12">
      <button class="btn" onclick="exportarKPI()">Exportar KPIs actuales (JSON)</button>
    </div>
  </section>

  <!-- COBROS -->
  <section id="cobros" class="card hidden">
    <h2 class="title"><span class="emoji">üí≥</span> Cobros & Recibos</h2>
    <div class="row">
      <div><label>Cliente</label><input id="cNombre"></div>
      <div><label>Tel√©fono (WhatsApp)</label><input id="cTel" placeholder="7871234567"></div>
    </div>
    <div class="row3">
      <div><label>Monto (USD)</label><input id="cMonto" type="number" min="0" step="0.01" value="0.00"></div>
      <div><label>M√©todo</label><select id="cMetodo"><option>ATH M√≥vil</option><option>Efectivo</option><option>Tarjeta</option></select></div>
      <div><label>Referencia (opcional)</label><input id="cRef" placeholder="#transacci√≥n / 4 √∫ltimos"></div>
    </div>
    <label>Concepto</label><input id="cConcepto" placeholder="Servicio(s) pagados">
    <div class="mt12">
      <button class="btn ok" onclick="guardarCobro()">Guardar cobro</button>
      <button class="btn accent" onclick="imprimirRecibo()">Exportar recibo (PDF)</button>
      <a id="waCobroLink" class="btn ok hidden" target="_blank">Enviar por WhatsApp</a>
    </div>
    <h2 class="mt16">Historial reciente</h2>
    <div id="listCobros" class="list"></div>
    <div class="mt12">
      <button class="btn" onclick="exportar('cobros','csv')">Exportar cobros (CSV)</button>
      <button class="btn" onclick="exportar('cobros','json')">Exportar cobros (JSON)</button>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dashboard" class="card hidden">
    <h2 class="title"><span class="emoji">üìä</span> Rendimiento</h2>
    <div class="kpis">
      <div class="kpi"><div class="mini">Citas (mes)</div><b id="mCitas">0</b></div>
      <div class="kpi"><div class="mini">No-Show (mes)</div><b id="mNS">0</b></div>
      <div class="kpi"><div class="mini">Ingresos (mes)</div><b id="mIng">0.00</b></div>
      <div class="kpi"><div class="mini">Ticket Prom.</div><b id="mTP">0.00</b></div>
    </div>
  </section>

  <!-- CUADRE -->
  <section id="cuadre" class="card hidden">
    <h2 class="title"><span class="emoji">üìë</span> Hoja de Cuadre Diario</h2>
    <div class="row">
      <div><label>URL de Google Sheets</label><input id="cfgSheetURL" value="https://docs.google.com/spreadsheets/d/1-MxlLqk6BLkYiThYros0F3DLCef0jd5tV-pUilMk3iM/edit"></div>
      <div><label>URL de Google Form (opcional)</label><input id="cfgFormURL" placeholder="https://docs.google.com/forms/..."></div>
    </div>
    <div class="mt12">
      <button class="btn accent" onclick="abrirCuadre()">Abrir Google Sheets</button>
      <button class="btn" onclick="abrirForm()">Abrir Google Form</button>
      <span class="help">Quedan guardados localmente.</span>
    </div>
  </section>

  <!-- CONFIG -->
  <section id="config" class="card hidden">
    <h2 class="title"><span class="emoji">‚öôÔ∏è</span> Configuraci√≥n</h2>

    <div class="row">
      <div><label>T√≠tulo Topbar</label><input id="cfgTopTitle" placeholder="LuxSalon ‚Äì Agenda & Servicios"></div>
      <div><label>Texto Footer</label><input id="cfgFooter" placeholder="¬© 2025 LuxSalon ‚Ä¢ (787) 664-3079 ‚Ä¢ oasisservicespr.com"></div>
    </div>

    <div class="row3">
      <div><label>Color Fondo</label><input id="cfgBg" type="color" value="#0d1117"></div>
      <div><label>Color Topbar</label><input id="cfgTopbar" type="color" value="#111827"></div>
      <div><label>Color Footer</label><input id="cfgFootColor" type="color" value="#111827"></div>
    </div>
    <div class="row3">
      <div><label>Bot√≥n Fondo</label><input id="cfgBtnBg" type="color" value="#15263a"></div>
      <div><label>Bot√≥n Borde</label><input id="cfgBtnBorder" type="color" value="#2a4157"></div>
      <div><label>Color Acento</label><input id="cfgAccent" type="color" value="#4cc2ff"></div>
    </div>
    <div class="row3">
      <div><label>OK</label><input id="cfgOk" type="color" value="#32d296"></div>
      <div><label>Warn</label><input id="cfgWarn" type="color" value="#ffd35a"></div>
      <div><label>Danger</label><input id="cfgDanger" type="color" value="#ff5678"></div>
    </div>

    <div class="row">
      <div>
        <label>Logo (PNG/JPG/SVG)</label><input id="cfgLogo" type="file" accept="image/*">
        <img id="cfgLogoPrev" class="mt12" style="height:70px;border:1px solid var(--line);border-radius:8px;background:#0003;padding:4px">
      </div>
      <div>
        <label>Fondo (PNG con transparencia)</label><input id="cfgBgImg" type="file" accept="image/*">
        <img id="cfgBgPrev" class="mt12" style="height:70px;border:1px solid var(--line);border-radius:8px;background:#0003;padding:4px">
      </div>
    </div>

    <h3 class="mt16">Operaci√≥n</h3>
    <div class="row3">
      <div><label>Inicio (HH:MM)</label><input id="cfgHIni" type="time" value="08:00"></div>
      <div><label>Fin (HH:MM)</label><input id="cfgHFin" type="time" value="17:00"></div>
      <div><label>Intervalo (min)</label><input id="cfgStep" type="number" min="15" step="15" value="30"></div>
    </div>
    <div>
      <label>T√©cnicas / Estilistas (una por l√≠nea)</label>
      <textarea id="cfgTecnicas" placeholder="Cynthia&#10;Mar√≠a&#10;Laura"></textarea>
    </div>

    <div class="row">
      <div>
        <label>Plantilla WhatsApp (agenda)</label>
        <textarea id="cfgTplWA">¬°Hola {NOMBRE}! Tu cita en {NEGOCIO} qued√≥ para el {FECHA} a las {HORA} con {TECNICA}. Ubicaci√≥n: {UBICACION}. ¬°Gracias!</textarea>
      </div>
      <div>
        <label>Plantilla WhatsApp (recordatorio 24h)</label>
        <textarea id="cfgTplREM">Recordatorio: {NOMBRE}, nos vemos ma√±ana {FECHA} a las {HORA} en {NEGOCIO} con {TECNICA}. Si necesitas cambiar la hora, av√≠sanos.</textarea>
      </div>
    </div>

    <div class="row">
      <div><label>Nombre de negocio</label><input id="cfgNegocio" value="LuxSalon"></div>
      <div><label>Ubicaci√≥n corta</label><input id="cfgUbic" value="Trujillo Alto, PR"></div>
    </div>

    <h3 class="mt16">Fuente y estilo</h3>
    <div class="row">
      <div>
        <label>Fuente</label>
        <select id="cfgFont">
          <option value='system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans",sans-serif'>System/Inter</option>
          <option value='Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif'>Inter</option>
          <option value='"SF Pro Text",-apple-system,system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif'>SF Pro</option>
          <option value='Roboto,system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif'>Roboto</option>
          <option value='Montserrat,Inter,system-ui,Arial,sans-serif'>Montserrat</option>
        </select>
      </div>
      <div>
        <label>Orden del men√∫ (arriba‚Üíabajo)</label>
        <select id="cfgMenuOrder" multiple size="9" style="height:160px">
          <!-- se rellena din√°micamente -->
        </select>
        <div class="mt8">
          <button class="btn" onclick="menuMove(-1)">‚¨ÜÔ∏è Subir</button>
          <button class="btn" onclick="menuMove(1)">‚¨áÔ∏è Bajar</button>
        </div>
      </div>
    </div>

    <h3 class="mt16">Acceso (m√∫ltiples usuarios)</h3>
    <div class="row">
      <div>
        <label>Nuevo usuario</label>
        <input id="newUser" placeholder="usuario">
      </div>
      <div>
        <label>Contrase√±a</label>
        <input id="newPass" type="password" placeholder="contrase√±a">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Rol</label>
        <select id="newRole">
          <option value="admin">admin</option>
          <option value="user">user</option>
        </select>
      </div>
      <div class="mt20">
        <button class="btn ok" onclick="addUser()">A√±adir usuario</button>
      </div>
    </div>
    <div class="mt12">
      <div class="list" id="usersList"></div>
      <div class="mt12">
        <button class="btn" onclick="exportar('logins','csv')">Exportar logins (CSV)</button>
        <button class="btn" onclick="exportar('logins','json')">Exportar logins (JSON)</button>
      </div>
    </div>

    <h3 class="mt16">Backups & Export</h3>
    <div class="row">
      <div>
        <label>Backup r√°pido (citas/cobros/no-show)</label>
        <div class="mt8">
          <button class="btn" onclick="exportBackup('daily')">Diario</button>
          <button class="btn" onclick="exportBackup('weekly')">Semanal</button>
          <button class="btn" onclick="exportBackup('monthly')">Mensual</button>
          <button class="btn" onclick="exportBackup('annual')">Anual</button>
        </div>
      </div>
      <div>
        <label>Backup de configuraci√≥n</label>
        <div class="mt8">
          <button class="btn accent" onclick="exportCfg()">Exportar Config (JSON)</button>
        </div>
      </div>
    </div>

    <div class="mt12">
      <button class="btn ok" onclick="guardarConfig()">Guardar cambios</button>
      <button class="btn danger" onclick="resetDemo()">Reiniciar (demo)</button>
    </div>
  </section>

  <!-- PWA secci√≥n -->
  <section id="pwa" class="card hidden">
    <h2 class="title"><span class="emoji">üì≤</span> Instalar como App</h2>
    <p class="mini">iPhone/iPad: <b>Compartir ‚Üí A√±adir a pantalla de inicio</b>. Android/desktop: usa el bot√≥n.</p>
    <button id="btnInstall" class="btn" style="display:none">Instalar aplicaci√≥n</button>
  </section>

  <!-- FOOTER -->
  <div id="appFooter" class="foot">¬© 2025 LuxSalon ‚Ä¢ (787) 664-3079 ‚Ä¢ oasisservicespr.com</div>
</div>

<!-- Bot√≥n flotante volver al men√∫ -->
<div class="backtop"><a class="btn ghost" href="#menu" title="Regresar al men√∫">‚¨ÜÔ∏è Men√∫</a></div>

<!-- Recibo (plantilla impresi√≥n) -->
<div id="reciboPrint" class="hidden">
  <div style="max-width:700px;margin:0 auto;padding:24px;font:14px/1.5 var(--font);color:#000">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
      <img id="reciboLogo" style="height:40px"/>
      <div>
        <div id="reciboNegocio" style="font-weight:700">LuxSalon</div>
        <div id="reciboFooter" style="font-size:12px;color:#333"></div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div style="font-size:12px">Fecha: <span id="reciboFecha"></span></div>
        <div style="font-size:12px">No.: <span id="reciboNo"></span></div>
      </div>
    </div>
    <hr>
    <div><b>Cliente:</b> <span id="reciboCliente"></span></div>
    <div><b>Tel.:</b> <span id="reciboTel"></span></div>
    <div class="mt8"><b>Concepto:</b> <span id="reciboConcepto"></span></div>
    <div class="mt8"><b>M√©todo:</b> <span id="reciboMetodo"></span></div>
    <div class="mt8"><b>Referencia:</b> <span id="reciboRef"></span></div>
    <div class="mt12" style="font-size:18px"><b>Total: $<span id="reciboTotal"></span></b></div>
    <hr class="mt12"><div style="font-size:12px;color:#444">Gracias por su preferencia.</div>
  </div>
</div>

<script>
/* ====== LocalStorage Keys ====== */
const LS = {
  cfg:'lux_cfg_v2',
  citas:'lux_citas_v2',
  cobros:'lux_cobros_v2',
  noshow:'lux_noshow_v2',
  users:'lux_users_v2',
  logins:'lux_logins_v2'
};
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));

/* ====== Config por defecto ====== */
let CFG = {
  topTitle:'LuxSalon ‚Äì Agenda & Servicios',
  footer:'¬© 2025 LuxSalon ‚Ä¢ (787) 664-3079 ‚Ä¢ oasisservicespr.com',
  colors:{bg:'#0d1117',topbar:'#111827',footer:'#111827',btnBg:'#15263a',btnBorder:'#2a4157',accent:'#4cc2ff',ok:'#32d296',warn:'#ffd35a',danger:'#ff5678'},
  logo:'', bgImg:'',
  horario:{ini:'08:00',fin:'17:00',step:30},
  tecnicas:['Cynthia','Mar√≠a','Laura'],
  tplWA:'¬°Hola {NOMBRE}! Tu cita en {NEGOCIO} qued√≥ para el {FECHA} a las {HORA} con {TECNICA}. Ubicaci√≥n: {UBICACION}. ¬°Gracias!',
  tplREM:'Recordatorio: {NOMBRE}, nos vemos ma√±ana {FECHA} a las {HORA} en {NEGOCIO} con {TECNICA}. Si necesitas cambiar la hora, av√≠sanos.',
  negocio:'LuxSalon',
  ubic:'Trujillo Alto, PR',
  sheetURL:'https://docs.google.com/spreadsheets/d/1-MxlLqk6BLkYiThYros0F3DLCef0jd5tV-pUilMk3iM/edit',
  formURL:'',
  font:'system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans",sans-serif',
  menuOrder:['agendar','disponibles','noshow','recordatorios','cobros','dashboard','cuadre','config','pwa'] /* IDs en ese orden */
};

/* ====== Usuarios (multi-user) ====== */
let USERS = [{user:'admin', pass:'admin', role:'admin'}];
let LOGIN_LOG = [];

function loadAll(){
  try{
    const c=localStorage.getItem(LS.cfg); if(c) CFG={...CFG, ...JSON.parse(c)};
    const u=localStorage.getItem(LS.users); if(u) USERS=JSON.parse(u);
    const l=localStorage.getItem(LS.logins); if(l) LOGIN_LOG=JSON.parse(l);
  }catch(e){console.warn(e)}
}
function saveCfg(){ localStorage.setItem(LS.cfg, JSON.stringify(CFG)); }
function saveUsers(){ localStorage.setItem(LS.users, JSON.stringify(USERS)); }
function saveLoginLog(){ localStorage.setItem(LS.logins, JSON.stringify(LOGIN_LOG)); }
function getCitas(){ return JSON.parse(localStorage.getItem(LS.citas)||'[]'); }
function setCitas(v){ localStorage.setItem(LS.citas, JSON.stringify(v)); }
function getCobros(){ return JSON.parse(localStorage.getItem(LS.cobros)||'[]'); }
function setCobros(v){ localStorage.setItem(LS.cobros, JSON.stringify(v)); }
function getNoShow(){ return JSON.parse(localStorage.getItem(LS.noshow)||'[]'); }
function setNoShow(v){ localStorage.setItem(LS.noshow, JSON.stringify(v)); }

/* ====== Utils ====== */
const nowISO=()=>new Date().toISOString();
const pad=(n,l=2)=>String(n).padStart(l,'0');
function rgbToHex(v){ if(/^#/.test(v)) return v; const c=document.createElement('canvas').getContext('2d'); c.fillStyle=v; const m=(c.fillStyle.match(/\d+/g)||[0,0,0]).slice(0,3); return '#'+m.map(x=>pad(Number(x).toString(16),2)).join(''); }
const toUSD=n=>Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtFecha=dt=>new Date(dt).toLocaleDateString(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric'});
const fmtHora=dt=>new Date(dt).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }
function download(name, content, type='text/plain'){
  const blob = new Blob([content], {type}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 3000);
}

/* ====== Brand / Aplicar colores/fuente ====== */
function applyBrand(){
  $('#tbTitle').textContent = CFG.topTitle;
  $('#appFooter').textContent = CFG.footer;
  document.documentElement.style.setProperty('--topbar', CFG.colors.topbar);
  document.documentElement.style.setProperty('--footer', CFG.colors.footer);
  document.documentElement.style.setProperty('--bg', CFG.colors.bg);
  document.documentElement.style.setProperty('--btn-bg', CFG.colors.btnBg);
  document.documentElement.style.setProperty('--btn-border', CFG.colors.btnBorder);
  document.documentElement.style.setProperty('--accent', CFG.colors.accent);
  document.documentElement.style.setProperty('--ok', CFG.colors.ok);
  document.documentElement.style.setProperty('--warn', CFG.colors.warn);
  document.documentElement.style.setProperty('--danger', CFG.colors.danger);
  document.documentElement.style.setProperty('--font', CFG.font);
  if(CFG.logo){ $('#tbLogo').src=CFG.logo; $('#welcomeLogo').src=CFG.logo; $('#homeLogo').src=CFG.logo; }
  document.body.style.backgroundImage = CFG.bgImg ? `url(${CFG.bgImg})` : 'none';
  $('#homeTitle').textContent = CFG.negocio; $('#welcomeTitle').textContent = CFG.negocio;
}

/* ====== Login ====== */
function doLogin(){
  const u = $('#loginUser').value.trim();
  const p = $('#loginPass').value.trim();
  const user = USERS.find(x=>x.user===u && x.pass===p);
  if(!user){ alert('Usuario o contrase√±a incorrectos.'); return; }
  LOGIN_LOG.push({user:u, ts:nowISO(), action:'login'}); saveLoginLog();
  showAfterLogin();
}
function showAfterLogin(){
  // mostrar men√∫ y home
  ['login','menu','home','agendar','disponibles','noshow','recordatorios','cobros','dashboard','cuadre','config','pwa']
    .forEach(id=>document.getElementById(id).classList.add('hidden'));
  $('#menu').classList.remove('hidden'); $('#home').classList.remove('hidden');
  renderMenu(); renderTecnicas(); renderCitas(); renderNoShow(); renderRendimiento(); renderCobros(); renderDashboard();
}

/* ====== Men√∫ (orden configurable) ====== */
const MENU_META = {
  agendar:{icon:'üóìÔ∏è',desc:'Google Calendar + WhatsApp'},
  disponibles:{icon:'‚úÖ',desc:'Seg√∫n tu horario y citas'},
  noshow:{icon:'üö´',desc:'Registra ausencias y gestiona'},
  recordatorios:{icon:'‚è∞',desc:'Env√≠o r√°pido por WhatsApp'},
  cobros:{icon:'üí≥',desc:'ATH M√≥vil, cash, tarjeta + PDF'},
  dashboard:{icon:'üìä',desc:'KPIs y m√©tricas'},
  cuadre:{icon:'üìë',desc:'Sheets / Forms'},
  config:{icon:'‚öôÔ∏è',desc:'Estilo, colores, usuarios‚Ä¶'},
  pwa:{icon:'üì≤',desc:'Instalar App'}
};
function renderMenu(){
  const list = $('#menuList'); list.innerHTML='';
  (CFG.menuOrder||Object.keys(MENU_META)).forEach(id=>{
    const meta = MENU_META[id]; if(!meta) return;
    const a=document.createElement('a'); a.className='menu-btn'; a.href='#'+id;
    a.innerHTML = `<span class="icon">${meta.icon}</span><span class="txt"><b>${titleFor(id)}</b><span>${meta.desc}</span></span>`;
    list.appendChild(a);
  });
}
function titleFor(id){
  return {
    agendar:'Agendar cita', disponibles:'Ver fechas disponibles', noshow:'No-Show',
    recordatorios:'Recordatorios 24h', cobros:'Cobros & Recibos', dashboard:'Rendimiento (Dashboard)',
    cuadre:'Hoja de Cuadre Diario', config:'Configuraci√≥n', pwa:'Instalar como App'
  }[id]||id;
}

/* ====== Config form ====== */
function loadConfigForm(){
  $('#cfgTopTitle').value=CFG.topTitle; $('#cfgFooter').value=CFG.footer;
  $('#cfgBg').value=rgbToHex(CFG.colors.bg); $('#cfgTopbar').value=rgbToHex(CFG.colors.topbar); $('#cfgFootColor').value=rgbToHex(CFG.colors.footer);
  $('#cfgBtnBg').value=rgbToHex(CFG.colors.btnBg); $('#cfgBtnBorder').value=rgbToHex(CFG.colors.btnBorder);
  $('#cfgAccent').value=rgbToHex(CFG.colors.accent); $('#cfgOk').value=rgbToHex(CFG.colors.ok); $('#cfgWarn').value=rgbToHex(CFG.colors.warn); $('#cfgDanger').value=rgbToHex(CFG.colors.danger);
  $('#cfgHIni').value=CFG.horario.ini; $('#cfgHFin').value=CFG.horario.fin; $('#cfgStep').value=CFG.horario.step;
  $('#cfgTecnicas').value=(CFG.tecnicas||[]).join('\n');
  $('#cfgTplWA').value=CFG.tplWA; $('#cfgTplREM').value=CFG.tplREM;
  $('#cfgNegocio').value=CFG.negocio; $('#cfgUbic').value=CFG.ubic;
  $('#cfgSheetURL').value=CFG.sheetURL||''; $('#cfgFormURL').value=CFG.formURL||'';
  $('#cfgLogoPrev').src=CFG.logo||''; $('#cfgBgPrev').src=CFG.bgImg||'';
  $('#cfgFont').value=CFG.font;
  // men√∫
  const sel = $('#cfgMenuOrder'); sel.innerHTML='';
  (CFG.menuOrder||Object.keys(MENU_META)).forEach(id=>{
    const opt=document.createElement('option'); opt.value=id; opt.textContent=titleFor(id); sel.appendChild(opt);
  });
  renderUsers();
}
function guardarConfig(){
  CFG.topTitle=$('#cfgTopTitle').value.trim()||CFG.topTitle;
  CFG.footer=$('#cfgFooter').value.trim()||CFG.footer;
  CFG.colors.bg=$('#cfgBg').value; CFG.colors.topbar=$('#cfgTopbar').value; CFG.colors.footer=$('#cfgFootColor').value;
  CFG.colors.btnBg=$('#cfgBtnBg').value; CFG.colors.btnBorder=$('#cfgBtnBorder').value;
  CFG.colors.accent=$('#cfgAccent').value; CFG.colors.ok=$('#cfgOk').value; CFG.colors.warn=$('#cfgWarn').value; CFG.colors.danger=$('#cfgDanger').value;
  CFG.horario.ini=$('#cfgHIni').value; CFG.horario.fin=$('#cfgHFin').value; CFG.horario.step=parseInt($('#cfgStep').value||30,10);
  CFG.tecnicas=$('#cfgTecnicas').value.split('\n').map(s=>s.trim()).filter(Boolean);
  CFG.tplWA=$('#cfgTplWA').value; CFG.tplREM=$('#cfgTplREM').value;
  CFG.negocio=$('#cfgNegocio').value.trim()||CFG.negocio; CFG.ubic=$('#cfgUbic').value.trim()||CFG.ubic;
  CFG.sheetURL=$('#cfgSheetURL').value.trim()||CFG.sheetURL; CFG.formURL=$('#cfgFormURL').value.trim()||CFG.formURL;
  CFG.font=$('#cfgFont').value;
  // men√∫ order
  const opts = Array.from($('#cfgMenuOrder').options).map(o=>o.value);
  CFG.menuOrder = opts;
  saveCfg(); applyBrand(); renderMenu();
  alert('Configuraci√≥n guardada.');
}
document.addEventListener('change', async (e)=>{
  if(e.target.id==='cfgLogo' && e.target.files[0]){ CFG.logo=await fileToDataURL(e.target.files[0]); saveCfg(); $('#cfgLogoPrev').src=CFG.logo; applyBrand(); }
  if(e.target.id==='cfgBgImg' && e.target.files[0]){ CFG.bgImg=await fileToDataURL(e.target.files[0]); saveCfg(); $('#cfgBgPrev').src=CFG.bgImg; applyBrand(); }
});
function menuMove(dir){
  const sel=$('#cfgMenuOrder'); const i=sel.selectedIndex; if(i<0) return;
  const opts=Array.from(sel.options);
  const j=i+dir; if(j<0 || j>=opts.length) return;
  const vi=opts[i].value; const vj=opts[j].value;
  opts[i].value=vj; opts[i].text=vj?titleFor(vj):vj; opts[i].text=titleFor(vj);
  opts[j].value=vi; opts[j].text=titleFor(vi);
  sel.selectedIndex=j;
}

/* ====== Usuarios ====== */
function renderUsers(){
  const box=$('#usersList'); box.innerHTML='';
  USERS.forEach((u,idx)=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><b>${u.user}</b> <span class="mini">(${u.role})</span></div>`;
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='btn danger'; del.textContent='Eliminar';
    del.onclick=()=>{ if(u.role==='admin' && USERS.filter(x=>x.role==='admin').length<=1){ alert('Debe existir al menos un admin.'); return; } USERS.splice(idx,1); saveUsers(); renderUsers(); };
    right.appendChild(del); div.appendChild(right); box.appendChild(div);
  });
}
function addUser(){
  const user=$('#newUser').value.trim(); const pass=$('#newPass').value.trim(); const role=$('#newRole').value;
  if(!user || !pass) return alert('Usuario y contrase√±a son requeridos.');
  if(USERS.some(u=>u.user===user)) return alert('Usuario ya existe.');
  USERS.push({user,pass,role}); saveUsers(); renderUsers(); $('#newUser').value=''; $('#newPass').value='';
}

/* ====== Agenda ====== */
function renderTecnicas(){
  const sel=$('#aTecnica'); sel.innerHTML='';
  (CFG.tecnicas||[]).forEach(t=>{const o=document.createElement('option'); o.textContent=t; sel.appendChild(o);});
}
function crearCita(){
  const nombre=$('#aNombre').value.trim();
  const tel=$('#aTel').value.replace(/\D/g,'');
  const servicio=$('#aServicio').value.trim();
  const tecnica=$('#aTecnica').value;
  const fecha=$('#aFecha').value; // ISO local yyyy-mm-ddThh:mm
  const dur=parseInt($('#aDur').value||60,10);
  const notas=$('#aNotas').value.trim();
  if(!nombre || !fecha){ alert('Nombre y fecha/hora son obligatorios.'); return; }

  // Regla anti-duplicado: misma persona (case-ins.), misma fecha/hora exacta y misma t√©cnica
  const citas=getCitas();
  const dup = citas.some(c =>
    c.nombre.trim().toLowerCase()===nombre.toLowerCase() &&
    c.fecha===fecha && c.tecnica===tecnica
  );
  if(dup){ alert('Ya existe una cita con esta persona a esa hora con la misma t√©cnica.'); return; }

  const id=Math.random().toString(36).slice(2,10);
  const cita={id,nombre,tel,servicio,tecnica,fecha,dur,notas,estado:'programada',ts:nowISO()};
  citas.push(cita); setCitas(citas);

  // Google Calendar
  const start=new Date(fecha), end=new Date(start.getTime()+dur*60000);
  const fmt=d=>d.toISOString().replace(/[-:]/g,'').replace(/\.\d+Z$/,'Z');
  const gc=new URLSearchParams({action:'TEMPLATE',text:`${servicio||'Cita'} ‚Äì ${nombre}`,dates:`${fmt(start)}/${fmt(end)}`,details:`Servicio: ${servicio}\nT√©cnica: ${tecnica}\nNotas: ${notas}`,location:CFG.ubic||''});
  $('#gcalLink').href=`https://calendar.google.com/calendar/render?${gc.toString()}`;
  $('#gcalLink').classList.remove('hidden');

  // WhatsApp agenda
  const msg=CFG.tplWA.replaceAll('{NOMBRE}',nombre).replaceAll('{NEGOCIO}',CFG.negocio).replaceAll('{FECHA}',fmtFecha(fecha)).replaceAll('{HORA}',fmtHora(fecha)).replaceAll('{TECNICA}',tecnica).replaceAll('{UBICACION}',CFG.ubic);
  $('#waLink').href=`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;
  $('#waLink').classList.remove('hidden');

  renderCitas(); renderRendimiento(); renderDashboard();
  alert('Cita creada. Abre Google Calendar y/o WhatsApp.');
}
function renderCitas(){
  const list=$('#listaCitas'); list.innerHTML='';
  const arr=getCitas().sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
  if(!arr.length){ list.innerHTML='<div class="mini">A√∫n no hay citas.</div>'; return; }
  arr.forEach(c=>{
    const div=document.createElement('div'); div.className='item';
    const left=document.createElement('div');
    left.innerHTML=`<b>${c.nombre}</b> <span class="mini">(${c.servicio||'‚Äî'})</span><br><span class="mini">${fmtFecha(c.fecha)} ${fmtHora(c.fecha)} ‚Ä¢ ${c.tecnica}</span>`;
    const right=document.createElement('div');
    const tel=(c.tel||'').replace(/\D/g,'');
    const msg=CFG.tplWA.replaceAll('{NOMBRE}',c.nombre).replaceAll('{NEGOCIO}',CFG.negocio).replaceAll('{FECHA}',fmtFecha(c.fecha)).replaceAll('{HORA}',fmtHora(c.fecha)).replaceAll('{TECNICA}',c.tecnica).replaceAll('{UBICACION}',CFG.ubic);
    const btnWA=document.createElement('a'); btnWA.className='btn ok'; btnWA.textContent='WhatsApp'; btnWA.target='_blank'; btnWA.href=`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;
    const btnNS=document.createElement('button'); btnNS.className='btn warn'; btnNS.textContent='No-Show'; btnNS.onclick=()=>marcarNoShow(c.id);
    const btnDel=document.createElement('button'); btnDel.className='btn danger'; btnDel.textContent='Eliminar'; btnDel.onclick=()=>eliminarCita(c.id);
    right.append(btnWA,btnNS,btnDel); div.append(left,right); list.appendChild(div);
  });
}
function marcarNoShow(id){
  const arr=getCitas(); const i=arr.findIndex(x=>x.id===id);
  if(i>=0){ const c=arr.splice(i,1)[0]; c.estado='no-show'; const ns=getNoShow(); ns.push(c); setNoShow(ns); setCitas(arr); renderCitas(); renderNoShow(); renderRendimiento(); renderDashboard(); }
}
function eliminarCita(id){
  if(!confirm('¬øEliminar esta cita?')) return;
  setCitas(getCitas().filter(x=>x.id!==id)); renderCitas(); renderRendimiento(); renderDashboard();
}

/* ====== Disponibles ====== */
function calcDisponibles(){
  const day=$('#dDia').value; const dur=parseInt($('#dDur').value||60,10);
  if(!day){ alert('Selecciona un d√≠a.'); return; }
  const startStr=`${day}T${CFG.horario.ini}:00`; const endStr=`${day}T${CFG.horario.fin}:00`; const step=CFG.horario.step;

  const taken=getCitas()
    .filter(c=>c.estado==='programada' && c.fecha.startsWith(day))
    .map(c=>({ini:new Date(c.fecha), fin:new Date(new Date(c.fecha).getTime()+c.dur*60000)}));

  const slots=[];
  for(let t=new Date(startStr); t<new Date(endStr); t=new Date(t.getTime()+step*60000)){
    const tEnd=new Date(t.getTime()+dur*60000);
    if(tEnd>new Date(endStr)) break;
    const overl= taken.some(x=> !(tEnd<=x.ini || t>=x.fin));
    if(!overl) slots.push({ini:new Date(t), fin:tEnd});
  }
  const list=$('#listDisponibles'); list.innerHTML='';
  if(!slots.length){ list.innerHTML='<div class="mini">No hay espacios con esa duraci√≥n.</div>'; return; }
  slots.forEach(s=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><b>${fmtHora(s.ini)}</b> ‚Äì ${fmtHora(s.fin)}</div>`;
    const b=document.createElement('button'); b.className='btn ok'; b.textContent='Usar';
    b.onclick=()=>{ location.hash='#agendar'; $('#aFecha').value=s.ini.toISOString().slice(0,16); };
    div.appendChild(b); list.appendChild(div);
  });
}

/* ====== No-Show ====== */
function renderNoShow(){
  const list=$('#listNoShow'); list.innerHTML='';
  const arr=getNoShow().sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
  if(!arr.length){ list.innerHTML='<div class="mini">Sin registros No-Show.</div>'; return; }
  arr.forEach(c=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><b>${c.nombre}</b> <span class="mini">${fmtFecha(c.fecha)} ${fmtHora(c.fecha)} ‚Ä¢ ${c.tecnica} ‚Ä¢ ${c.servicio||''}</span></div>`;
    const del=document.createElement('button'); del.className='btn danger'; del.textContent='Eliminar';
    del.onclick=()=>{ setNoShow(getNoShow().filter(x=>x.id!==c.id)); renderNoShow(); };
    div.appendChild(del); list.appendChild(div);
  });
}

/* ====== Recordatorios y KPIs ====== */
function proximas24h(){
  const now=Date.now(), max=now+36*3600*1000;
  return getCitas().filter(c=>{const t=new Date(c.fecha).getTime(); return c.estado==='programada' && t>now && t<=max;})
    .sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
}
function renderRendimiento(){
  const list=$('#listRecordatorios'); list.innerHTML='';
  const arr=proximas24h(); if(!arr.length){ list.innerHTML='<div class="mini">No hay citas dentro de 24‚Äì36h.</div>'; }
  arr.forEach(c=>{
    const tel=(c.tel||'').replace(/\D/g,'');
    const msg=CFG.tplREM.replaceAll('{NOMBRE}',c.nombre).replaceAll('{NEGOCIO}',CFG.negocio).replaceAll('{FECHA}',fmtFecha(c.fecha)).replaceAll('{HORA}',fmtHora(c.fecha)).replaceAll('{TECNICA}',c.tecnica).replaceAll('{UBICACION}',CFG.ubic);
    const a=document.createElement('a'); a.className='item'; a.target='_blank'; a.href=`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;
    a.innerHTML=`<div><b>${c.nombre}</b> <span class="mini">${fmtFecha(c.fecha)} ${fmtHora(c.fecha)} ‚Ä¢ ${c.tecnica}</span></div><span class="btn ok">WhatsApp</span>`;
    list.appendChild(a);
  });
}
function renderDashboard(){
  const today=new Date().toISOString().slice(0,10);
  const citas=getCitas();
  const hoy=citas.filter(c=> c.fecha.startsWith(today));
  $('#kpiHoy').textContent=hoy.length;
  const prox=citas.filter(c=> new Date(c.fecha)>new Date()).sort((a,b)=> new Date(a.fecha)-new Date(b.fecha))[0];
  $('#kpiProx').textContent=prox?`Pr√≥xima: ${fmtHora(prox.fecha)} (${prox.nombre})`:'Sin pr√≥ximas';
  const m=new Date().getMonth(), y=new Date().getFullYear();
  $('#kpiMes').textContent=citas.filter(c=> new Date(c.fecha).getMonth()===m && new Date(c.fecha).getFullYear()===y).length;
  $('#kpiNoShow').textContent=getNoShow().filter(c=> new Date(c.fecha).getMonth()===m && new Date(c.fecha).getFullYear()===y).length;

  const cobros=getCobros();
  const hoyCob=cobros.filter(c=> (c.ts||'').slice(0,10)===today);
  const sumHoy=hoyCob.reduce((s,x)=> s+Number(x.monto||0),0);
  $('#kpiIngresos').textContent=toUSD(sumHoy); $('#kpiTickets').textContent=hoyCob.length;

  // M√©tricas mensuales (para export KPI)
  window.__KPIS__ = (function(){
    const citasMes=citas.filter(c=> new Date(c.fecha).getMonth()===m && new Date(c.fecha).getFullYear()===y );
    const noshowMes=getNoShow().filter(c=> new Date(c.fecha).getMonth()===m && new Date(c.fecha).getFullYear()===y );
    const ingresosMes=cobros.filter(c=>{const d=new Date(c.ts||c.fecha); return d.getMonth()===m && d.getFullYear()===y;})
      .reduce((s,x)=> s+Number(x.monto||0),0);
    const ticketsMes=cobros.filter(c=>{const d=new Date(c.ts||c.fecha); return d.getMonth()===m && d.getFullYear()===y;}).length;
    return {month:m+1,year:y,citas:citasMes.length,noShow:noshowMes.length,ingresos:ingresosMes,ticketProm:ticketsMes? ingresosMes/ticketsMes : 0};
  })();

  // kpi mini en home
  $('#mCitas').textContent=__KPIS__.citas;
  $('#mNS').textContent=__KPIS__.noShow;
  $('#mIng').textContent=toUSD(__KPIS__.ingresos);
  $('#mTP').textContent=toUSD(__KPIS__.ticketProm);
}

/* ====== Cobros ====== */
function guardarCobro(){
  const nombre=$('#cNombre').value.trim();
  const tel=$('#cTel').value.replace(/\D/g,'');
  const monto=Number($('#cMonto').value||0);
  const metodo=$('#cMetodo').value;
  const ref=$('#cRef').value.trim();
  const concepto=$('#cConcepto').value.trim();
  if(!nombre || !monto){ alert('Cliente y monto son obligatorios.'); return; }
  const reg={id:Math.random().toString(36).slice(2,10), nombre, tel, monto, metodo, ref, concepto, ts:nowISO()};
  const arr=getCobros(); arr.push(reg); setCobros(arr); renderCobros(); renderDashboard(); renderRendimiento();

  const msg=`Recibo ${CFG.negocio}\nCliente: ${nombre}\nConcepto: ${concepto}\nM√©todo: ${metodo}\nMonto: $${toUSD(monto)}\nRef: ${ref||'N/A'}`;
  const wa=`https://wa.me/${tel}?text=${encodeURIComponent(msg)}`;
  const a=$('#waCobroLink'); a.href=wa; a.classList.remove('hidden');
  alert('Cobro guardado. Puedes exportar el recibo o enviarlo por WhatsApp.');
}
function renderCobros(){
  const list=$('#listCobros'); list.innerHTML='';
  const arr=getCobros().sort((a,b)=> new Date(b.ts)-new Date(a.ts)).slice(0,12);
  if(!arr.length){ list.innerHTML='<div class="mini">Sin cobros recientes.</div>'; return; }
  arr.forEach(c=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`<div><b>${c.nombre}</b> <span class="mini">$${toUSD(c.monto)} ‚Ä¢ ${c.metodo} ‚Ä¢ ${new Date(c.ts).toLocaleString()}</span></div>`;
    const b=document.createElement('button'); b.className='btn'; b.textContent='Recibo'; b.onclick=()=>prepararRecibo(c);
    div.appendChild(b); list.appendChild(div);
  });
}
function prepararRecibo(c){
  $('#reciboLogo').src=CFG.logo||''; $('#reciboNegocio').textContent=CFG.negocio||'LuxSalon';
  $('#reciboFooter').textContent=CFG.footer||''; $('#reciboFecha').textContent=new Date(c.ts).toLocaleString();
  $('#reciboNo').textContent=c.id.toUpperCase(); $('#reciboCliente').textContent=c.nombre; $('#reciboTel').textContent=c.tel||'';
  $('#reciboConcepto').textContent=c.concepto||''; $('#reciboMetodo').textContent=c.metodo||''; $('#reciboRef').textContent=c.ref||'N/A';
  $('#reciboTotal').textContent=toUSD(c.monto); imprimirRecibo();
}
function imprimirRecibo(){
  const win=window.open('','_blank');
  const html=`<html><head><title>Recibo</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"></head><body>${$('#reciboPrint').innerHTML}<script>window.print();<\/script></body></html>`;
  win.document.write(html); win.document.close();
}

/* ====== Export/Backup ====== */
function toCSV(arr){
  if(!arr || !arr.length) return '';
  const cols = Object.keys(arr[0]);
  const esc = v => `"${String(v??'').replace(/"/g,'""')}"`;
  const lines = [cols.join(',')].concat(arr.map(o=>cols.map(k=>esc(o[k])).join(',')));
  return lines.join('\n');
}
function exportar(kind, fmt){
  let data=[];
  if(kind==='citas') data=getCitas();
  if(kind==='cobros') data=getCobros();
  if(kind==='noshow') data=getNoShow();
  if(kind==='logins') data=LOGIN_LOG;
  const name = `${kind}-${new Date().toISOString().slice(0,10)}.${fmt}`;
  if(fmt==='csv') download(name, toCSV(data), 'text/csv');
  else download(name, JSON.stringify(data,null,2), 'application/json');
}
function exportCfg(){
  const name=`config-${new Date().toISOString().slice(0,10)}.json`;
  download(name, JSON.stringify(CFG,null,2), 'application/json');
}
function exportKPI(){
  const snap = {ts: nowISO(), negocio: CFG.negocio, ...window.__KPIS__};
  const name=`kpis-${new Date().toISOString().slice(0,10)}.json`;
  download(name, JSON.stringify(snap,null,2), 'application/json');
}
function exportBackup(period){
  const now = new Date();
  let from = new Date(now);
  if(period==='daily') from.setDate(now.getDate()-1);
  if(period==='weekly') from.setDate(now.getDate()-7);
  if(period==='monthly') from.setMonth(now.getMonth()-1);
  if(period==='annual') from.setFullYear(now.getFullYear()-1);
  const inRange = (d)=> new Date(d)>=from && new Date(d)<=now;

  const citas = getCitas().filter(c=> inRange(c.fecha||c.ts));
  const cobros = getCobros().filter(c=> inRange(c.ts||c.fecha));
  const noshow = getNoShow().filter(c=> inRange(c.fecha||c.ts));
  const payload = {period, from:from.toISOString(), to:now.toISOString(), citas, cobros, noshow};
  const name=`backup-${period}-${now.toISOString().slice(0,10)}.json`;
  download(name, JSON.stringify(payload,null,2), 'application/json');
}

/* ====== Navegaci√≥n por hash ====== */
function routeFromHash(){
  const id=location.hash.slice(1)||'menu';
  ['menu','home','agendar','disponibles','noshow','recordatorios','cobros','dashboard','cuadre','config','pwa']
    .forEach(v=>document.getElementById(v).classList.add('hidden'));
  $('#menu').classList.remove('hidden');
  const t=document.getElementById(id); if(t){ t.classList.remove('hidden'); t.scrollIntoView({behavior:'smooth',block:'start'}); }
  if(id==='config') loadConfigForm();
  if(id==='disponibles'){ $('#dDia').valueAsDate=new Date(); $('#listDisponibles').innerHTML=''; }
}
window.addEventListener('hashchange', routeFromHash);

/* ====== Cuadre ====== */
function abrirCuadre(){ CFG.sheetURL=$('#cfgSheetURL').value.trim()||CFG.sheetURL; saveCfg(); if(CFG.sheetURL) window.open(CFG.sheetURL,'_blank'); else alert('Agrega la URL del Google Sheet.'); }
function abrirForm(){ CFG.formURL=$('#cfgFormURL').value.trim()||CFG.formURL; saveCfg(); if(CFG.formURL) window.open(CFG.formURL,'_blank'); else alert('Agrega la URL del Google Form.'); }

/* ====== INIT & PWA ====== */
function init(){
  loadAll(); applyBrand();
  // Inicial
  ['menu','home','agendar','disponibles','noshow','recordatorios','cobros','dashboard','cuadre','config','pwa'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  $('#login').classList.remove('hidden');

  // PWA
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(console.warn); }
  let deferredPrompt=null; const btn=$('#btnInstall');
  window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; if(btn) btn.style.display='inline-flex'; });
  btn?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; btn.style.display='none'; });

  // Soft reminder 15 min
  setTimeout(()=>{
    const soon=getCitas().filter(c=>{const t=new Date(c.fecha).getTime(); const dt=t-Date.now(); return c.estado==='programada' && dt>0 && dt<=15*60*1000;});
    if(soon.length && confirm(`Tienes ${soon.length} cita(s) dentro de 15 min. ¬øIr a Recordatorios?`)){ location.hash='#recordatorios'; }
  }, 600);
}
init();

window.addEventListener('load', ()=>{ /* si ya logueado futuro: se podr√≠a autoabrir */ });

/* Exponer funciones si hace falta en consola */
window.exportar=exportar;
window.exportCfg=exportCfg;
window.exportBackup=exportBackup;
window.exportKPI=exportKPI;
window.guardarConfig=guardarConfig;
window.resetDemo=()=>{ if(confirm('Borrar datos locales (citas, cobros, config, usuarios, logins)?')){ Object.values(LS).forEach(k=>localStorage.removeItem(k)); location.reload(); } };
window.addUser=addUser;
window.abrirCuadre=abrirCuadre;
window.abrirForm=abrirForm;
window.crearCita=crearCita;
window.calcDisponibles=calcDisponibles;
window.guardarCobro=guardarCobro;
window.imprimirRecibo=imprimirRecibo;
</script>
</body>
</html>
